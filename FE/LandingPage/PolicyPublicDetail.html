<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iPOOR | Chi tiết chính sách</title>
    <link rel="icon" type="image/png" href="../Image/icon.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --navy-900: #0f172a;
            --navy-800: #162544;
            --blue-500: #2563eb;
            --blue-100: #e1ecff;
            --gray-50: #f8fafc;
            --gray-100: #e5e7eb;
            --gray-500: #6b7280;
            --white: #ffffff;
            --card-shadow: 0 16px 36px rgba(15, 23, 42, 0.08);
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Inter', sans-serif; background: #f5f7fb; color: var(--navy-900); }
        a { color: inherit; text-decoration: none; }

        header {
            position: sticky; top: 0; z-index: 100;
            background: var(--white);
            box-shadow: 0 1px 10px rgba(15, 23, 42, 0.08);
        }
        .nav { max-width: 1200px; margin: 0 auto; padding: 14px 18px; display: flex; align-items: center; justify-content: space-between; gap: 12px; }
        .brand { display: flex; align-items: center; gap: 10px; font-weight: 800; }
        .brand img { width: 32px; height: 32px; object-fit: contain; }
        .brand small { display: none; }
        .menu { display: flex; align-items: center; gap: 18px; font-weight: 700; }
        .menu a { color: var(--navy-900); position: relative; }
        .menu a::after {
            content: '';
            position: absolute;
            left: 0;
            bottom: -6px;
            width: 0;
            height: 3px;
            border-radius: 999px;
            background: linear-gradient(90deg, #2563eb, #22c55e);
            transition: width 0.2s ease;
        }
        .menu a:hover { color: var(--blue-500); }
        .menu a:hover::after { width: 100%; }
        .btn-login {
            background: linear-gradient(90deg, #0f172a, #1f2f54);
            color: var(--white);
            padding: 10px 16px;
            border-radius: 999px;
            font-weight: 800;
            box-shadow: 0 10px 20px rgba(37, 99, 235, 0.15);
        }
        .btn-login:visited, .btn-login:active { color: var(--white); }
        .btn-login:hover { background: linear-gradient(90deg, #1f2f54, #0f172a); }
        .menu-toggle {
            display: none;
            background: transparent;
            border: 1px solid var(--gray-100);
            border-radius: 10px;
            padding: 8px;
            cursor: pointer;
        }
        .menu-toggle span {
            display: block;
            width: 22px;
            height: 2px;
            background: var(--navy-900);
            margin: 4px 0;
        }

        .hero { max-width: 900px; margin: 0 auto; padding: 28px 18px; display: grid; gap: 12px; }
        .hero h1 { font-size: 32px; }
        .meta { color: var(--gray-500); font-size: 14px; display: flex; gap: 12px; flex-wrap: wrap; }
        .tag { display: inline-flex; align-items: center; padding: 6px 10px; border-radius: 999px; font-size: 12px; font-weight: 700; background: #e2e8f0; color: var(--navy-900); }
        .tag.policy { background: #eef2ff; color: #4338ca; }
        .tag.report { background: #ecfeff; color: #0ea5e9; }
        .tag.guide { background: #fef9c3; color: #a16207; }
        .tag.news { background: #e0f2fe; color: #0369a1; }
        .tag.announcement { background: #fee2e2; color: #b91c1c; }
        .tag.other { background: #f4f4f5; color: #52525b; }

        .content { max-width: 900px; margin: 0 auto; padding: 0 18px 36px; }
        .article { background: var(--white); border: 1px solid var(--gray-100); border-radius: 16px; box-shadow: var(--card-shadow); padding: 20px; display: grid; gap: 14px; }
        .article p { color: var(--gray-500); line-height: 1.7; }
        .article h2, .article h3 { font-size: 20px; margin-top: 6px; }
        .article ul, .article ol { margin-left: 18px; color: var(--gray-500); line-height: 1.6; display: grid; gap: 6px; }
        .article .list-dash, .article .list-plus { list-style: none; padding-left: 0; }
        .article .list-dash li::before { content: "– "; color: var(--navy-900); font-weight: 700; }
        .article .list-plus li::before { content: "+ "; color: var(--navy-900); font-weight: 700; }
        .article .list-circle { list-style-type: circle; }
        .article .list-alpha { list-style-type: lower-alpha; }
        .article .list-roman { list-style-type: lower-roman; }
        .article figure { margin: 0; display: grid; gap: 8px; }
        .article figure img { width: 100%; border-radius: 12px; }
        .article figcaption { color: var(--gray-500); font-size: 13px; }
        .article blockquote { border-left: 3px solid #93c5fd; padding-left: 12px; color: var(--gray-500); font-style: italic; display: grid; gap: 6px; }
        .article blockquote cite { font-style: normal; font-weight: 700; color: var(--navy-900); }
        .article table { width: 100%; border-collapse: collapse; }
        .article th, .article td { border: 1px solid var(--gray-100); padding: 8px 10px; text-align: left; }
        .article th { background: #f8fafc; }
        .article .embed { position: relative; width: 100%; padding-top: 56.25%; border-radius: 12px; overflow: hidden; background: #0f172a; }
        .article .embed iframe { position: absolute; inset: 0; width: 100%; height: 100%; border: 0; }
        .article hr { border: none; border-top: 1px solid var(--gray-100); margin: 8px 0; }
        .attachment { display: flex; align-items: center; gap: 10px; padding: 12px 14px; border: 1px dashed var(--gray-100); border-radius: 12px; background: #fff7ed; }
        .attachment a { font-weight: 700; color: #ea580c; }
        .status { padding: 12px 14px; border-radius: 12px; background: #f8fafc; border: 1px solid var(--gray-100); color: var(--gray-500); font-weight: 700; }
        .status.error { background: #fef2f2; border-color: #fecdd3; color: #b91c1c; }

        @media (max-width: 820px) {
            .menu {
                position: absolute;
                top: 64px;
                right: 18px;
                background: var(--white);
                border: 1px solid var(--gray-100);
                border-radius: 12px;
                box-shadow: 0 10px 24px rgba(15, 23, 42, 0.12);
                padding: 12px;
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
                display: none;
            }
            .menu.open { display: flex; }
            .menu-toggle { display: inline-flex; align-items: center; justify-content: center; }
        }
    </style>
</head>
<body>
<header>
    <div class="nav">
        <a class="brand" href="./index.html">
            <img src="../Image/icon.png" alt="iPOOR">
            <div>
                <div>iPOOR</div>
                <small>Cổng tin tức</small>
            </div>
        </a>
        <button class="menu-toggle" id="menuToggle" aria-label="Mở menu điều hướng">
            <span></span>
            <span></span>
            <span></span>
        </button>
        <div class="menu" id="menuPanel">
            <a href="./NewsPublic.html">Tin tức & Chính sách</a>
            <a href="./index.html#reports">Báo cáo</a>
            <a href="./index.html#about">Về iPOOR</a>
            <a href="./GISPublic.html">Bản đồ nghèo</a>
            <a class="btn-login" href="../Auth/Login.html">Đăng nhập cán bộ</a>
        </div>
    </div>
</header>

<section class="hero" id="heroSection">
    <div class="tag">Đang tải</div>
    <h1>Đang tải nội dung...</h1>
    <div class="meta" id="metaLine"></div>
</section>

<section class="content">
    <article class="article" id="articleBody">
        <p>Vui lòng chờ trong giây lát.</p>
    </article>
    <div class="status" id="statusBox" style="margin-top: 12px; display: none;"></div>
</section>

<script>
    const API_BASE_URL = '/api';
    const POLICY_DETAIL_ENDPOINT = `${API_BASE_URL}/policies/public`;
    const heroSection = document.getElementById('heroSection');
    const metaLine = document.getElementById('metaLine');
    const articleBody = document.getElementById('articleBody');
    const statusBox = document.getElementById('statusBox');

    const typeLabels = {
        decree: { text: 'Chính sách', cls: 'policy' },
        circular: { text: 'Chính sách', cls: 'policy' },
        policy: { text: 'Chính sách', cls: 'policy' },
        report: { text: 'Báo cáo', cls: 'report' },
        guideline: { text: 'Hướng dẫn', cls: 'guide' },
        guide: { text: 'Hướng dẫn', cls: 'guide' },
        news: { text: 'Tin tức', cls: 'news' },
        announcement: { text: 'Thông báo', cls: 'announcement' },
        other: { text: 'Khác', cls: 'other' },
    };

    function mapCategory(category) {
        return typeLabels[category] || typeLabels.other;
    }

    function formatDate(value) {
        if (!value) return '';
        const d = new Date(value);
        return isNaN(d.getTime()) ? '' : d.toLocaleDateString('vi-VN');
    }

    function normalizeAttachmentUrl(value) {
        if (!value) return '';
        if (value.startsWith('http://') || value.startsWith('https://')) return value;
        if (value.startsWith('/')) return `${API_BASE_URL}${value}`;
        return value;
    }

    function sanitizeHtml(input) {
        const template = document.createElement('template');
        template.innerHTML = input || '';
        const allowedTags = new Set(['B', 'STRONG', 'I', 'EM', 'U', 'A', 'MARK', 'BR', 'SPAN']);
        const allowedAttrs = {
            A: new Set(['href', 'target', 'rel']),
        };
        const walker = document.createTreeWalker(template.content, NodeFilter.SHOW_ELEMENT);
        const nodesToRemove = [];
        while (walker.nextNode()) {
            const node = walker.currentNode;
            if (!allowedTags.has(node.tagName)) {
                nodesToRemove.push(node);
                continue;
            }
            const attrs = Array.from(node.attributes);
            attrs.forEach((attr) => {
                const allowed = allowedAttrs[node.tagName];
                if (!allowed || !allowed.has(attr.name)) {
                    node.removeAttribute(attr.name);
                }
            });
            if (node.tagName === 'A') {
                node.setAttribute('rel', 'noopener');
                node.setAttribute('target', '_blank');
            }
        }
        nodesToRemove.forEach((node) => {
            const text = document.createTextNode(node.textContent || '');
            node.replaceWith(text);
        });
        return template.innerHTML;
    }

    function renderList(items, listStyle, ordered, level = 0) {
        const style = listStyle || (ordered ? 'decimal' : 'disc');
        const listClass = {
            dash: 'list-dash',
            plus: 'list-plus',
            circle: 'list-circle',
            'lower-alpha': 'list-alpha',
            'lower-roman': 'list-roman',
        }[style] || '';
        const tag = ordered ? 'ol' : 'ul';
        const nestedStyle = level > 0 && !ordered ? 'circle' : style;
        const nestedClass = {
            dash: 'list-dash',
            plus: 'list-plus',
            circle: 'list-circle',
            'lower-alpha': 'list-alpha',
            'lower-roman': 'list-roman',
        }[nestedStyle] || '';
        const className = level > 0 ? nestedClass : listClass;
        const liItems = items.map((item) => {
            if (typeof item === 'string') {
                return `<li>${sanitizeHtml(item)}</li>`;
            }
            const content = sanitizeHtml(item.content || '');
            const children = Array.isArray(item.items) && item.items.length
                ? renderList(item.items, nestedStyle, ordered, level + 1)
                : '';
            return `<li>${content}${children}</li>`;
        }).join('');
        return `<${tag} class="${className}">${liItems}</${tag}>`;
    }

    function renderBlocks(blockData) {
        if (!blockData || !Array.isArray(blockData.blocks)) return '';
        return blockData.blocks.map((block) => {
            if (!block || !block.data) return '';
            const alignment = block.data.alignment || '';
            const alignStyle = alignment ? ` style="text-align:${alignment}"` : '';
            if (block.type === 'header') {
                const level = Math.min(Math.max(block.data.level || 3, 2), 3);
                return `<h${level}${alignStyle}>${sanitizeHtml(block.data.text || '')}</h${level}>`;
            }
            if (block.type === 'paragraph') {
                return `<p${alignStyle}>${sanitizeHtml(block.data.text || '')}</p>`;
            }
            if (block.type === 'quote') {
                const quote = sanitizeHtml(block.data.text || '');
                const caption = sanitizeHtml(block.data.caption || '');
                return `<blockquote${alignStyle}><p>${quote}</p>${caption ? `<cite>${caption}</cite>` : ''}</blockquote>`;
            }
            if (block.type === 'list' || block.type === 'nestedList') {
                const items = block.data.items || [];
                const ordered = block.data.style === 'ordered';
                const listHtml = renderList(items, block.data.listStyle, ordered);
                return alignStyle ? `<div${alignStyle}>${listHtml}</div>` : listHtml;
            }
            if (block.type === 'image') {
                const url = normalizeAttachmentUrl(block.data.file?.url || '');
                const caption = sanitizeHtml(block.data.caption || '');
                if (!url) return '';
                return `<figure${alignStyle}><img src="${url}" alt="${caption}" loading="lazy">${caption ? `<figcaption>${caption}</figcaption>` : ''}</figure>`;
            }
            if (block.type === 'delimiter') {
                return `<hr${alignStyle}>`;
            }
            if (block.type === 'table') {
                const rows = Array.isArray(block.data.content) ? block.data.content : [];
                if (!rows.length) return '';
                const withHeadings = Boolean(block.data.withHeadings);
                const headerCells = withHeadings
                    ? rows[0].map((cell) => `<th>${sanitizeHtml(cell)}</th>`).join('')
                    : '';
                const bodyRows = (withHeadings ? rows.slice(1) : rows).map((row) => {
                    const cells = row.map((cell) => `<td>${sanitizeHtml(cell)}</td>`).join('');
                    return `<tr>${cells}</tr>`;
                }).join('');
                const headHtml = withHeadings ? `<thead><tr>${headerCells}</tr></thead>` : '';
                return `<table${alignStyle}>${headHtml}<tbody>${bodyRows}</tbody></table>`;
            }
            if (block.type === 'embed') {
                const embedUrl = block.data.embed || '';
                if (!embedUrl) return '';
                return `<div class="embed"${alignStyle}><iframe src="${embedUrl}" loading="lazy" allowfullscreen></iframe></div>`;
            }
            return '';
        }).join('');
    }

    function showStatus(message, isError = false) {
        statusBox.textContent = message;
        statusBox.classList.toggle('error', isError);
        statusBox.style.display = 'block';
    }

    async function loadPolicy() {
        const params = new URLSearchParams(window.location.search);
        const policyId = params.get('id');
        if (!policyId) {
            showStatus('Không tìm thấy bài viết.', true);
            return;
        }
        try {
            const res = await fetch(`${POLICY_DETAIL_ENDPOINT}/${policyId}`);
            if (!res.ok) {
                showStatus('Không tìm thấy bài viết.', true);
                return;
            }
            const policy = await res.json();
            const category = mapCategory(policy.category || 'other');
            const dateLabel = formatDate(policy.updated_at || policy.created_at);
            heroSection.querySelector('.tag').className = `tag ${category.cls}`;
            heroSection.querySelector('.tag').textContent = category.text;
            heroSection.querySelector('h1').textContent = policy.title || 'Chưa có tiêu đề';
            metaLine.innerHTML = `
                <span>${dateLabel}</span>
                <span>${policy.issued_by || 'iPOOR'}</span>
            `;
            const attachment = normalizeAttachmentUrl(policy.attachment_url || '');
            const blocksHtml = renderBlocks(policy.content_blocks);
            const contentHtml = blocksHtml || `<p>${policy.description || policy.summary || 'Chưa có nội dung chi tiết.'}</p>`;
            articleBody.innerHTML = `
                ${contentHtml}
                ${attachment ? `
                    <div class="attachment">
                        <a href="${attachment}" target="_blank" rel="noopener">Tải tài liệu đính kèm</a>
                    </div>
                ` : ''}
            `;
        } catch (error) {
            showStatus('Không tải được bài viết.', true);
        }
    }

    const menuToggle = document.getElementById('menuToggle');
    const menuPanel = document.getElementById('menuPanel');
    if (menuToggle && menuPanel) {
        menuToggle.addEventListener('click', () => {
            menuPanel.classList.toggle('open');
        });
        document.addEventListener('click', (event) => {
            if (!menuPanel.contains(event.target) && !menuToggle.contains(event.target)) {
                menuPanel.classList.remove('open');
            }
        });
    }

    loadPolicy();
</script>
</body>
</html>
