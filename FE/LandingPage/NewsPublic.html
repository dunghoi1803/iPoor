<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iPOOR | Tin tức & Chính sách</title>
    <link rel="icon" type="image/png" href="../Image/icon.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --navy-900: #0f172a;
            --navy-800: #162544;
            --blue-500: #2563eb;
            --blue-100: #e1ecff;
            --gray-50: #f8fafc;
            --gray-100: #e5e7eb;
            --gray-500: #6b7280;
            --white: #ffffff;
            --card-shadow: 0 16px 36px rgba(15, 23, 42, 0.08);
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Inter', sans-serif; color: var(--navy-900); background: #f5f7fb; }
        a { color: inherit; text-decoration: none; }

        header {
            position: sticky; top: 0; z-index: 100;
            background: var(--white);
            box-shadow: 0 1px 10px rgba(15, 23, 42, 0.08);
        }
        .nav { max-width: 1200px; margin: 0 auto; padding: 14px 18px; display: flex; align-items: center; justify-content: space-between; gap: 12px; }
        .brand { display: flex; align-items: center; gap: 10px; font-weight: 800; }
        .brand img { width: 32px; height: 32px; object-fit: contain; }
        .brand small { display: none; }
        .menu { display: flex; align-items: center; gap: 18px; font-weight: 700; }
        .menu a { color: var(--navy-900); position: relative; }
        .menu a::after {
            content: '';
            position: absolute;
            left: 0;
            bottom: -6px;
            width: 0;
            height: 3px;
            border-radius: 999px;
            background: linear-gradient(90deg, #2563eb, #22c55e);
            transition: width 0.2s ease;
        }
        .menu a:hover { color: var(--blue-500); }
        .menu a:hover::after { width: 100%; }
        .btn-login {
            background: linear-gradient(90deg, #0f172a, #1f2f54);
            color: var(--white);
            padding: 10px 16px;
            border-radius: 999px;
            font-weight: 800;
            box-shadow: 0 10px 20px rgba(37, 99, 235, 0.15);
        }
        .btn-login:visited, .btn-login:active { color: var(--white); }
        .btn-login:hover { background: linear-gradient(90deg, #1f2f54, #0f172a); }
        .menu-toggle {
            display: none;
            background: transparent;
            border: 1px solid var(--gray-100);
            border-radius: 10px;
            padding: 8px;
            cursor: pointer;
        }
        .menu-toggle span {
            display: block;
            width: 22px;
            height: 2px;
            background: var(--navy-900);
            margin: 4px 0;
        }

        .page-hero {
            max-width: 1200px; margin: 0 auto; padding: 28px 18px 18px;
            display: grid; gap: 14px;
        }
        .page-hero h1 { font-size: 36px; }
        .page-hero p { color: var(--gray-500); max-width: 720px; }
        .ticker {
            display: flex; align-items: center; gap: 10px;
            padding: 10px 14px; border-radius: 12px;
            background: var(--white); border: 1px solid var(--gray-100);
            box-shadow: var(--card-shadow); font-weight: 700;
        }
        .ticker span { color: var(--gray-500); font-weight: 600; }

        .filters { max-width: 1200px; margin: 0 auto; padding: 0 18px 18px; display: flex; gap: 12px; flex-wrap: wrap; }
        .filters select, .filters input { padding: 10px 12px; border: 1px solid var(--gray-100); border-radius: 10px; font-weight: 600; background: var(--white); }
        .filters button { padding: 10px 14px; border-radius: 10px; border: none; background: var(--navy-900); color: var(--white); font-weight: 700; cursor: pointer; }
        .filters button:hover { background: var(--navy-800); }

        .layout { max-width: 1200px; margin: 0 auto; padding: 0 18px 36px; display: grid; gap: 18px; grid-template-columns: 2fr 1fr; }
        .feature-card { background: var(--white); border: 1px solid var(--gray-100); border-radius: 16px; box-shadow: var(--card-shadow); overflow: hidden; display: grid; }
        .feature-cover { height: 260px; background: linear-gradient(135deg, #dbeafe, #eef2ff); display: grid; place-items: center; overflow: hidden; }
        .feature-cover img { width: 100%; height: 100%; object-fit: cover; display: block; }
        .feature-body { padding: 18px; display: grid; gap: 10px; }
        .feature-title { font-size: 24px; }
        .feature-desc { color: var(--gray-500); }

        .tag { display: inline-flex; align-items: center; padding: 6px 10px; border-radius: 999px; font-size: 12px; font-weight: 700; background: #e2e8f0; color: var(--navy-900); }
        .tag.policy { background: #eef2ff; color: #4338ca; }
        .tag.report { background: #ecfeff; color: #0ea5e9; }
        .tag.guide { background: #fef9c3; color: #a16207; }
        .tag.news { background: #e0f2fe; color: #0369a1; }
        .tag.announcement { background: #fee2e2; color: #b91c1c; }
        .tag.other { background: #f4f4f5; color: #52525b; }
        .meta { color: var(--gray-500); font-size: 13px; }

        .side-list { display: grid; gap: 10px; }
        .side-item { padding: 12px; background: var(--white); border-radius: 12px; border: 1px solid var(--gray-100); box-shadow: var(--card-shadow); display: grid; gap: 6px; }
        .side-item h4 { font-size: 16px; }

        .section { max-width: 1200px; margin: 0 auto; padding: 0 18px 36px; display: grid; gap: 12px; }
        .section-title { font-size: 22px; }
        .cards { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 260px)); gap: 16px; justify-content: start; }
        .card { background: var(--white); border: 1px solid var(--gray-100); border-radius: 14px; overflow: hidden; box-shadow: var(--card-shadow); display: grid; gap: 10px; }
        .card img { width: 100%; height: 160px; object-fit: cover; background: #e2e8f0; }
        .card-body { padding: 14px; display: grid; gap: 8px; }
        .card-title {
            font-weight: 800;
            font-size: 16px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .card-desc { color: var(--gray-500); font-size: 14px; }

        .report-grid { display: grid; gap: 12px; }
        .report-item { background: var(--white); border: 1px solid var(--gray-100); border-radius: 12px; padding: 12px; display: flex; gap: 10px; align-items: center; box-shadow: var(--card-shadow); }
        .report-icon { width: 40px; height: 40px; border-radius: 10px; background: #fee2e2; display: grid; place-items: center; font-weight: 800; color: #b91c1c; }
        .report-action { color: var(--blue-500); font-weight: 800; margin-left: auto; }

        footer { background: var(--navy-900); color: var(--white); padding: 28px 18px; margin-top: 36px; }
        .footer-inner { max-width: 1200px; margin: 0 auto; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; }
        .footer-title { font-weight: 800; margin-bottom: 10px; }
        .footer-links a { display: block; color: #e2e8f0; margin-bottom: 6px; }
        .footer-meta { margin-top: 12px; color: #cbd5e1; }

        @media (max-width: 1024px) {
            .layout { grid-template-columns: 1fr; }
        }
        @media (max-width: 820px) {
            .menu {
                position: absolute;
                top: 64px;
                right: 18px;
                background: var(--white);
                border: 1px solid var(--gray-100);
                border-radius: 12px;
                box-shadow: 0 10px 24px rgba(15, 23, 42, 0.12);
                padding: 12px;
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
                display: none;
            }
            .menu.open { display: flex; }
            .menu-toggle { display: inline-flex; align-items: center; justify-content: center; }
        }
    </style>
</head>
<body>
<header>
    <div class="nav">
        <a class="brand" href="./index.html">
            <img src="../Image/icon.png" alt="iPOOR">
            <div>
                <div>iPOOR</div>
                <small>Cổng tin tức</small>
            </div>
        </a>
        <button class="menu-toggle" id="menuToggle" aria-label="Mở menu điều hướng">
            <span></span>
            <span></span>
            <span></span>
        </button>
        <div class="menu" id="menuPanel">
            <a href="./NewsPublic.html">Tin tức & Chính sách</a>
            <a href="./index.html#reports">Báo cáo</a>
            <a href="./index.html#about">Về iPOOR</a>
            <a href="./GISPublic.html">Bản đồ nghèo</a>
            <a class="btn-login" href="../Auth/Login.html">Đăng nhập cán bộ</a>
        </div>
    </div>
</header>

<section class="page-hero">
    <h1>Tin tức & Chính sách giảm nghèo đa chiều</h1>
    <p>Trang tin tổng hợp các chính sách, báo cáo và thông tin nổi bật về giảm nghèo đa chiều trên toàn quốc.</p>
    <div class="ticker" id="newsTicker">
        <strong>Điểm tin nhanh</strong>
        <span>Đang tải dữ liệu...</span>
    </div>
</section>

<div class="filters">
    <select id="newsFilter">
        <option value="all">Tất cả</option>
        <option value="policy">Chính sách</option>
        <option value="report">Báo cáo</option>
        <option value="guide">Hướng dẫn</option>
        <option value="news">Tin tức</option>
        <option value="announcement">Thông báo</option>
        <option value="other">Khác</option>
    </select>
    <input id="newsSearch" type="text" placeholder="Tìm theo tiêu đề hoặc nội dung...">
    <button id="newsSearchBtn" type="button">Tìm kiếm</button>
</div>

<div class="layout">
    <div class="feature-card" id="featuredMain">
        <div class="feature-cover"></div>
        <div class="feature-body">
            <span class="tag">Chính sách</span>
            <h3 class="feature-title">Đang tải tin nổi bật...</h3>
            <p class="feature-desc">Vui lòng chờ trong giây lát.</p>
        </div>
    </div>
    <div class="side-list" id="featuredList"></div>
</div>

<section class="section">
    <div class="section-title">Tin mới cập nhật</div>
    <div class="cards" id="newsCards"></div>
</section>

<section class="section">
    <div class="section-title">Báo cáo & tài liệu tham khảo</div>
    <div class="report-grid" id="reportList"></div>
</section>

<footer>
    <div class="footer-inner">
        <div>
            <div class="footer-title">iPOOR</div>
            <div>Cổng thông tin công khai về giảm nghèo đa chiều.</div>
        </div>
        <div class="footer-links">
            <a href="./NewsPublic.html">Tin tức & Chính sách</a>
            <a href="./GISPublic.html">Bản đồ nghèo</a>
            <a href="./index.html#about">Về iPOOR</a>
            <a href="../Auth/Login.html">Đăng nhập cán bộ</a>
        </div>
        <div>
            <div class="footer-title">Liên hệ</div>
            <div>Email: support@ipoor.gov.vn</div>
            <div>Điện thoại: (024) 1234 5678</div>
            <div>Địa chỉ: Bộ LĐTBXH, Hà Nội</div>
        </div>
    </div>
    <div class="footer-meta">© 2025 iPOOR</div>
</footer>

<script>
    const API_BASE_URL = '/api';
    const PUBLIC_POLICY_ENDPOINT = `${API_BASE_URL}/policies/public`;
    const NEWS_LIMIT = 24;
    const featuredMain = document.getElementById('featuredMain');
    const featuredList = document.getElementById('featuredList');
    const newsCards = document.getElementById('newsCards');
    const reportList = document.getElementById('reportList');
    const newsFilter = document.getElementById('newsFilter');
    const newsSearch = document.getElementById('newsSearch');
    const newsTicker = document.getElementById('newsTicker');
    const newsSearchBtn = document.getElementById('newsSearchBtn');
    let publicPolicies = [];

    const typeLabels = {
        decree: { text: 'Chính sách', cls: 'policy' },
        circular: { text: 'Chính sách', cls: 'policy' },
        policy: { text: 'Chính sách', cls: 'policy' },
        report: { text: 'Báo cáo', cls: 'report' },
        guideline: { text: 'Hướng dẫn', cls: 'guide' },
        guide: { text: 'Hướng dẫn', cls: 'guide' },
        news: { text: 'Tin tức', cls: 'news' },
        announcement: { text: 'Thông báo', cls: 'announcement' },
        other: { text: 'Khác', cls: 'other' },
    };

    function mapCategory(category) {
        return typeLabels[category] || typeLabels.other;
    }

    function formatDate(value) {
        if (!value) return '';
        const d = new Date(value);
        return isNaN(d.getTime()) ? '' : d.toLocaleDateString('vi-VN');
    }

    function stripHtml(value) {
        const el = document.createElement('div');
        el.innerHTML = value || '';
        return (el.textContent || '').trim();
    }

    function getSummary(value) {
        const text = stripHtml(value);
        if (!text) return '';
        return text.length > 160 ? `${text.slice(0, 160)}...` : text;
    }

    function normalizeAttachmentUrl(value) {
        if (!value) return '';
        if (value.startsWith('http://') || value.startsWith('https://')) return value;
        if (value.startsWith('/')) return `${API_BASE_URL}${value}`;
        return value;
    }

    function isImageUrl(value) {
        return /\.(png|jpe?g|webp)$/i.test(value || '');
    }

    function isImageSource(value) {
        return isImageUrl(value) || (value || '').startsWith('data:image/');
    }

    function getFirstBlockImage(item) {
        const blocks = item?.content_blocks?.blocks;
        if (!Array.isArray(blocks)) return '';
        const imageBlock = blocks.find((block) => block?.type === 'image' && block?.data?.file?.url);
        if (!imageBlock) return '';
        return normalizeAttachmentUrl(imageBlock.data.file.url || '');
    }

    function buildPolicyLink(id) {
        return `./PolicyPublicDetail.html?id=${id}`;
    }

    function renderFeatured(items) {
        if (!featuredMain || !featuredList) return;
        featuredList.innerHTML = '';
        if (!items.length) {
            featuredMain.innerHTML = `
                <div class="feature-cover"></div>
                <div class="feature-body">
                    <span class="tag">Chính sách</span>
                    <h3 class="feature-title">Chưa có bài viết công khai</h3>
                    <p class="feature-desc">Vui lòng quay lại sau khi có dữ liệu cập nhật.</p>
                </div>
            `;
            return;
        }
        const [main, ...rest] = items;
        const mainCategory = mapCategory(main.category || 'other');
        const mainImage = getFirstBlockImage(main) || normalizeAttachmentUrl(main.attachment_url || '');
        const mainCover = mainImage && isImageSource(mainImage)
            ? `<img src="${mainImage}" alt="${main.title || ''}">`
            : '';
        featuredMain.innerHTML = `
            <div class="feature-cover">${mainCover}</div>
            <div class="feature-body">
                <span class="tag ${mainCategory.cls}">${mainCategory.text}</span>
                <h3 class="feature-title">${main.title || 'Chưa có tiêu đề'}</h3>
                <p class="feature-desc">${getSummary(main.summary || main.description || '')}</p>
                <a class="btn-login" href="${buildPolicyLink(main.id)}">Đọc bài</a>
            </div>
        `;
        rest.slice(0, 4).forEach((item) => {
            const cat = mapCategory(item.category || 'other');
            const meta = [formatDate(item.updated_at || item.created_at), cat.text].filter(Boolean).join(' · ');
            const card = document.createElement('a');
            card.className = 'side-item';
            card.href = buildPolicyLink(item.id);
            card.innerHTML = `
                <div class="meta">${meta}</div>
                <h4>${item.title || 'Chưa có tiêu đề'}</h4>
            `;
            featuredList.appendChild(card);
        });
    }

    function renderNews(items) {
        if (!newsCards) return;
        newsCards.innerHTML = '';
        if (!items.length) {
            newsCards.innerHTML = '<div class="meta">Chưa có bài viết công khai.</div>';
            return;
        }
        items.slice(0, 9).forEach((item) => {
            const cat = mapCategory(item.category || 'other');
            const imageSource = getFirstBlockImage(item) || normalizeAttachmentUrl(item.attachment_url || '');
            const imageTag = imageSource && isImageSource(imageSource)
                ? `<img src="${imageSource}" alt="${item.title || ''}">`
                : `<img src="../Image/icon.png" alt="iPOOR">`;
            const meta = [item.issued_by, formatDate(item.updated_at || item.created_at)]
                .filter(Boolean)
                .join(' · ');
            const card = document.createElement('a');
            card.className = 'card';
            card.href = buildPolicyLink(item.id);
            card.innerHTML = `
                ${imageTag}
                <div class="card-body">
                    <span class="tag ${cat.cls}">${cat.text}</span>
                    <div class="card-title">${item.title || 'Chưa có tiêu đề'}</div>
                    <div class="card-desc">${getSummary(item.summary || item.description || '')}</div>
                    <div class="meta">${meta}</div>
                </div>
            `;
            newsCards.appendChild(card);
        });
    }

    function renderReports(items) {
        if (!reportList) return;
        reportList.innerHTML = '';
        const reportItems = items.filter((item) => {
            const isPublic = item.is_public === 1 || item.is_public === true;
            if (!isPublic) return false;
            return Boolean(normalizeAttachmentUrl(item.attachment_url || ''));
        });
        if (!reportItems.length) {
            reportList.innerHTML = '<div class="meta">Chưa có báo cáo công khai.</div>';
            return;
        }
        reportItems.slice(0, 6).forEach((item) => {
            const attachment = normalizeAttachmentUrl(item.attachment_url || '');
            const card = document.createElement('div');
            card.className = 'report-item';
            card.innerHTML = `
                <div class="report-icon">PDF</div>
                <div class="report-body">
                    <div class="card-title">${item.title || 'Chưa có tiêu đề'}</div>
                    <div class="meta">${formatDate(item.updated_at || item.created_at)}</div>
                </div>
                <a class="report-action" href="${attachment}" target="_blank" rel="noopener">Tải về</a>
            `;
            reportList.appendChild(card);
        });
    }

    function updateTicker(items) {
        if (!newsTicker) return;
        if (!items.length) {
            newsTicker.innerHTML = '<strong>Điểm tin nhanh</strong><span>Chưa có dữ liệu.</span>';
            return;
        }
        const headline = items[0];
        newsTicker.innerHTML = `<strong>Điểm tin nhanh</strong><span>${headline.title || 'Chưa có tiêu đề'}</span>`;
    }

    function buildPublicQueryParams(type, keyword, limit) {
        const params = new URLSearchParams();
        if (limit) params.set('limit', String(limit));
        if (keyword) params.set('q', keyword);
        if (type === 'policy') {
            params.set('category_group', 'policy');
        } else if (type === 'guide') {
            params.set('category_group', 'guide');
        } else if (type === 'report') {
            params.set('category', 'report');
        } else if (type === 'news') {
            params.set('category', 'news');
        } else if (type === 'announcement') {
            params.set('category', 'announcement');
        }
        return params.toString();
    }

    async function searchPublicPolicies(type, keyword) {
        const query = buildPublicQueryParams(type, keyword, NEWS_LIMIT);
        const url = `${PUBLIC_POLICY_ENDPOINT}?${query}`;
        const res = await fetch(url);
        if (!res.ok) {
            return [];
        }
        const items = await res.json();
        if (type === 'other') {
            return items.filter((item) => !['decree', 'circular', 'policy', 'report', 'guideline', 'guide', 'news', 'announcement'].includes(item.category));
        }
        return items;
    }

    async function applyFilters() {
        const keyword = (newsSearch?.value || '').toLowerCase().trim();
        const type = newsFilter?.value || 'all';
        const results = await searchPublicPolicies(type, keyword);
        renderNews(results);
        updateTicker(results);
    }

    async function loadPublicPolicies() {
        try {
            const res = await fetch(`${PUBLIC_POLICY_ENDPOINT}?limit=${NEWS_LIMIT}`);
            if (!res.ok) {
                renderFeatured([]);
                renderNews([]);
                renderReports([]);
                updateTicker([]);
                return;
            }
            publicPolicies = await res.json();
            renderFeatured(publicPolicies);
            renderNews(publicPolicies);
            renderReports(publicPolicies);
            updateTicker(publicPolicies);
        } catch (error) {
            renderFeatured([]);
            renderNews([]);
            renderReports([]);
            updateTicker([]);
        }
    }

    const menuToggle = document.getElementById('menuToggle');
    const menuPanel = document.getElementById('menuPanel');
    if (menuToggle && menuPanel) {
        menuToggle.addEventListener('click', () => {
            menuPanel.classList.toggle('open');
        });
        document.addEventListener('click', (event) => {
            if (!menuPanel.contains(event.target) && !menuToggle.contains(event.target)) {
                menuPanel.classList.remove('open');
            }
        });
    }

    if (newsFilter) {
        newsFilter.addEventListener('change', applyFilters);
    }
    if (newsSearch) {
        newsSearch.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                event.preventDefault();
                applyFilters();
            }
        });
    }
    if (newsSearchBtn) {
        newsSearchBtn.addEventListener('click', applyFilters);
    }

    loadPublicPolicies();
</script>
</body>
</html>
