<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iPOOR | Dashboard</title>
    <link rel="icon" type="image/png" href="../Image/icon.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --navy-900: #0f172a;
            --navy-800: #162544;
            --navy-700: #1f2f54;
            --blue-500: #3b82f6;
            --blue-300: #60a5fa;
            --blue-100: #e1ecff;
            --orange-400: #f59e0b;
            --gray-50: #f5f7fa;
            --gray-100: #e5e7eb;
            --gray-400: #94a3b8;
            --gray-500: #6b7280;
            --white: #ffffff;
            --card-shadow: 0 10px 30px rgba(15, 23, 42, 0.08);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Manrope', system-ui, -apple-system, sans-serif;
            background: var(--gray-50);
            color: var(--navy-900);
        }

        .app-shell { display: grid; grid-template-columns: 260px 1fr; min-height: 100vh; }
        .sidebar { background: var(--navy-900); color: var(--white); display: flex; flex-direction: column; padding: 20px 18px; }
        .brand { display: flex; align-items: center; gap: 12px; padding: 10px 12px 20px; }
        .brand-mark { width: 44px; height: 44px; border-radius: 12px; background: var(--white); display: grid; place-items: center; }
        .brand-logo { width: 30px; height: 30px; object-fit: contain; }
        .brand-name { font-size: 18px; font-weight: 700; letter-spacing: 0.4px; }
        nav { margin-top: 8px; display: grid; gap: 6px; }
        .nav-item { display: flex; align-items: center; gap: 12px; padding: 12px 14px; border-radius: 10px; color: var(--white); text-decoration: none; transition: background 0.2s, transform 0.1s; }
        .nav-item:hover { background: var(--navy-800); transform: translateX(2px); }
        .nav-item.active { background: var(--navy-700); border-left: 3px solid var(--blue-500); }
        .nav-icon { width: 16px; height: 16px; display: inline-flex; align-items: center; justify-content: center; }

        .main-area { display: flex; flex-direction: column; min-height: 100vh; }
        .topbar { background: var(--white); height: 72px; display: flex; align-items: center; justify-content: space-between; padding: 0 24px; box-shadow: 0 1px 0 rgba(148, 163, 184, 0.35); position: relative; }
        .breadcrumb { color: var(--gray-500); font-weight: 600; letter-spacing: 0.2px; }
        .breadcrumb strong { color: var(--navy-900); }
        .user-meta { display: flex; align-items: center; gap: 12px; position: relative; }
        .avatar { width: 38px; height: 38px; border-radius: 50%; background: var(--blue-500); color: var(--white); display: grid; place-items: center; font-weight: 700; }
        .user-info { display: flex; flex-direction: column; align-items: flex-end; }
        .user-name { font-weight: 700; }
        .user-role { color: var(--gray-500); font-size: 13px; }
        .dropdown { border: 1px solid var(--gray-100); border-radius: 10px; padding: 8px 12px; background: var(--white); display: flex; gap: 8px; align-items: center; cursor: pointer; transition: box-shadow 0.15s; }
        .dropdown:hover { box-shadow: 0 4px 12px rgba(15, 23, 42, 0.12); }
        .dropdown-menu { position: absolute; right: 0; top: 60px; background: var(--white); border: 1px solid var(--gray-100); border-radius: 12px; box-shadow: 0 14px 28px rgba(15,23,42,0.15); display: none; min-width: 180px; overflow: hidden; }
        .dropdown-menu.open { display: block; }
        .dropdown-item { width: 100%; text-align: left; padding: 10px 14px; border: none; background: transparent; cursor: pointer; font-weight: 600; color: var(--navy-900); transition: background 0.15s; }
        .dropdown-item:hover { background: #f8fafc; }

        .content { flex: 1; padding: 24px; background: var(--gray-50); display: grid; gap: 18px; }
        .page-header { display: flex; flex-direction: column; gap: 8px; }
        .page-title { font-size: 24px; font-weight: 800; letter-spacing: -0.2px; }
        .page-subtitle { color: var(--gray-500); max-width: 680px; }

        .stat-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 14px; }
        .kpi-filters { display: flex; justify-content: space-between; align-items: center; gap: 12px; flex-wrap: wrap; }
        .kpi-filters .select { min-width: 180px; }
        .stat-card { background: var(--white); border: 1px solid var(--gray-100); border-radius: 14px; padding: 16px; box-shadow: var(--card-shadow); display: grid; gap: 10px; }
        .stat-head { display: flex; align-items: center; gap: 10px; color: var(--gray-500); font-weight: 600; }
        .stat-value { font-size: 28px; font-weight: 800; }
        .stat-pill { display: inline-flex; align-items: center; gap: 6px; padding: 6px 10px; border-radius: 999px; font-size: 12px; font-weight: 700; }
        .pill-positive { background: #ecfdf3; color: #15803d; }
        .pill-warning { background: #fff7ed; color: #c2410c; }

        .panel-grid { display: grid; grid-template-columns: minmax(0, 1fr) minmax(0, 1fr); gap: 16px; align-items: start; }
        .panel-column { display: grid; gap: 16px; }
        .panel-placeholder { background: transparent; min-height: 200px; }
        .panel { background: var(--white); border: 1px solid var(--gray-100); border-radius: 16px; box-shadow: var(--card-shadow); padding: 18px; display: grid; gap: 12px; }
        .panel-title { font-weight: 800; font-size: 17px; }
        .panel-toolbar { display: flex; justify-content: space-between; align-items: center; gap: 10px; flex-wrap: wrap; }
        .select { padding: 8px 10px; border-radius: 10px; border: 1px solid var(--gray-100); background: var(--white); font-weight: 600; color: var(--navy-900); }
        .chart-area { background: linear-gradient(180deg, rgba(59,130,246,0.05), rgba(15,23,42,0.02)); border: 1px dashed var(--gray-100); border-radius: 12px; padding: 8px; overflow-x: auto; }
        .bar-chart-wrap { display: flex; gap: 12px; align-items: center; }
        .bar-legend { display: grid; gap: 8px; font-size: 13px; color: var(--gray-500); min-width: 140px; }
        .bar-legend-item { display: flex; align-items: center; gap: 8px; }
        .bar-legend-swatch { width: 12px; height: 12px; border-radius: 4px; display: inline-block; }

        .trend-filters { display: flex; gap: 10px; align-items: center; justify-content: flex-end; flex-wrap: wrap; }
        .trend-filters .select { min-width: 180px; }

        .legend { display: flex; gap: 12px; flex-wrap: wrap; color: var(--gray-500); font-size: 13px; }
        .legend span { display: inline-flex; align-items: center; gap: 6px; }
        .legend i { width: 12px; height: 12px; border-radius: 4px; display: inline-block; }

        .quick-links { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px; }
        .link-card { background: var(--white); border: 1px solid var(--gray-100); border-radius: 14px; padding: 16px; box-shadow: var(--card-shadow); display: flex; align-items: center; justify-content: space-between; gap: 10px; text-decoration: none; color: var(--navy-900); transition: transform 0.15s, box-shadow 0.2s; }
        .link-card:hover { transform: translateY(-2px); box-shadow: 0 14px 28px rgba(15,23,42,0.12); }
        .link-title { font-weight: 800; }
        .link-desc { color: var(--gray-500); font-size: 13px; }
        .link-icon { width: 38px; height: 38px; border-radius: 12px; background: var(--blue-100); color: var(--blue-500); display: grid; place-items: center; font-weight: 800; }
        .household-list { display: grid; gap: 10px; }
        .household-card { border: 1px solid var(--gray-100); border-radius: 12px; padding: 12px; background: var(--white); box-shadow: var(--card-shadow); display: grid; gap: 6px; }
        .household-meta { color: var(--gray-500); font-size: 13px; }
        .pill { display: inline-flex; align-items: center; gap: 6px; padding: 4px 10px; border-radius: 999px; font-size: 12px; font-weight: 700; background: var(--blue-100); color: var(--navy-900); width: fit-content; }

        @media (max-width: 1120px) {
            .panel-grid { grid-template-columns: 1fr; }
            .panel-placeholder { display: none; }
        }
        @media (max-width: 960px) {
            .app-shell { grid-template-columns: 72px 1fr; }
            .brand-name { display: none; }
            .nav-item span { display: none; }
        }
        @media (max-width: 680px) {
            .app-shell { grid-template-columns: 1fr; }
            .sidebar { flex-direction: row; overflow-x: auto; height: 72px; }
            nav { grid-auto-flow: column; grid-auto-columns: max-content; align-items: center; }
            .dropdown-menu { top: 66px; }
        }
    </style>
</head>
<body>
<div class="app-shell">
    <aside class="sidebar">
        <div class="brand">
            <div class="brand-mark">
                <img src="../Image/icon.png" alt="iPOOR" class="brand-logo">
            </div>
            <div class="brand-name">iPOOR</div>
        </div>
                <nav>
            <a class="nav-item" href="../LandingPage/index.html">
                <span class="nav-icon"><svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M2 7.5 8 2l6 5.5V14H9.5v-3h-3v3H2V7.5Z" fill="white" opacity="0.9"/></svg></span>
                <span>Trang giới thiệu</span>
            </a>
            <a class="nav-item active" href="./HomePage.html">
                <span class="nav-icon"><svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M8 2a6 6 0 0 0-6 6v2.5A1.5 1.5 0 0 0 3.5 12h9A1.5 1.5 0 0 0 14 10.5V8a6 6 0 0 0-6-6Z" stroke="white" stroke-width="1.3"/><path d="M8 8 10.8 6.2" stroke="white" stroke-width="1.3" stroke-linecap="round"/><circle cx="8" cy="8" r="1" fill="white"/></svg></span>
                <span>Dashboard</span>
            </a>
            <a class="nav-item" href="./HouseholdList.html">
                <span class="nav-icon"><svg width="16" height="16" viewBox="0 0 16 16" fill="none"><rect x="2" y="3" width="12" height="10" rx="2" stroke="white" stroke-width="1.4"/><path d="M5 3v10" stroke="white" stroke-width="1.2" opacity="0.7"/><circle cx="11" cy="7" r="1" fill="white"/></svg></span>
                <span>Quản lý hộ nghèo</span>
            </a>
            <a class="nav-item" href="./DataCollection.html">
                <span class="nav-icon"><svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M2.5 5.5h11v1.5h-11V5.5Zm0 3h7v1.5h-7V8.5Zm0 3h5v1.5h-5V11.5Z" fill="white" opacity="0.9"/><path d="M10.5 3v10" stroke="white" stroke-width="1.2" opacity="0.7"/></svg></span>
                <span>Thu thập & cập nhật dữ liệu</span>
            </a>
            <a class="nav-item" href="./PolicyList.html">
                <span class="nav-icon"><svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M3 13V3h10v10H3Z" stroke="white" stroke-width="1.3"/><path d="M5 6.5h6M5 9h3.5" stroke="white" stroke-width="1.2" stroke-linecap="round"/></svg></span>
                <span>Chính sách & báo cáo</span>
            </a>
            <a class="nav-item" href="./GISMap.html">
                <span class="nav-icon"><svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M2.7 7.3c0-2.5 2-4.5 4.5-4.5s4.5 2 4.5 4.5-2 4.5-4.5 4.5c-.7 0-1.3-.15-1.9-.44l-2.05.58.55-1.95c-.36-.62-.6-1.34-.6-2.09Z" stroke="white" stroke-width="1.3"/><path d="M6.5 6.8c0-.7.6-1.2 1.2-1.2.7 0 1.2.5 1.2 1.2 0 .6-.5 1.2-1.2 1.2-.7 0-1.2-.6-1.2-1.2Z" fill="white"/></svg></span>
                <span>Bản đồ nghèo (GIS)</span>
            </a>
            <a class="nav-item" href="./ActivityLogs.html">
                <span class="nav-icon"><svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M4.5 3.5h7m-7 9h7M8 1.5v2m0 9v2M5.5 6h5L9.8 10H6.2L5.5 6Z" stroke="white" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/></svg></span>
                <span>Nhật ký hoạt động</span>
            </a>
        </nav>
    </aside>

    <div class="main-area">
        <header class="topbar">
            <div class="breadcrumb"><strong>Trang chủ</strong> / Dashboard</div>
            <div class="user-meta">
                <div class="user-info">
                    <span class="user-name" id="userName">Nguyễn Văn A</span>
                    <span class="user-role" id="userRole">Cán bộ tỉnh</span>
                </div>
                <div class="avatar">NA</div>
                <button class="dropdown" id="accountDropdown">Tài khoản ▾</button>
                <div class="dropdown-menu" id="dropdownMenu">
                    <button class="dropdown-item" data-action="change-password">Đổi mật khẩu</button>
                    <button class="dropdown-item" data-action="logout">Đăng xuất</button>
                </div>
            </div>
        </header>

        <main class="content">
            <div class="page-header">
                <div class="page-title">Tổng quan tình hình nghèo đa chiều</div>
                <div class="page-subtitle">Cập nhật nhanh số hộ nghèo, cận nghèo, thoát nghèo và các trường hợp nguy cơ để ưu tiên can thiệp.</div>
            </div>

            <div class="kpi-filters">
                <div class="panel-title">Tổng quan theo phạm vi</div>
                <div class="trend-filters">
                    <select id="kpi-scope-select" class="select" aria-label="Chọn phạm vi KPI">
                        <option value="country">Toàn quốc</option>
                        <option value="region">Khu vực</option>
                        <option value="province">Tỉnh</option>
                    </select>
                    <select id="kpi-name-select" class="select" aria-label="Chọn khu vực hoặc tỉnh KPI">
                        <option value="" disabled selected>Chọn khu vực hoặc tỉnh</option>
                    </select>
                </div>
            </div>

            <section class="stat-grid">
                <div class="stat-card">
                    <div class="stat-head">
                        <div class="nav-icon"><svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M2.5 8.5 8 3l5.5 5.5-1.5.5v4H4v-4l-1.5-.5Z" fill="#3b82f6"/></svg></div>
                        <span>Tổng số hộ nghèo</span>
                    </div>
                    <div class="stat-value">125,430</div>
                    <span class="stat-pill pill-warning">+2.1% so với năm trước</span>
                </div>
                <div class="stat-card">
                    <div class="stat-head">
                        <div class="nav-icon"><svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M8 2.5a5.5 5.5 0 0 1 5.5 5.5c0 3.2-2.7 5.5-5.5 5.5S2.5 11.2 2.5 8 4.8 2.5 8 2.5Z" stroke="#22d3ee" stroke-width="1.3"/><path d="M6 8.2 7.6 10 11 6.5" stroke="#3b82f6" stroke-width="1.3" stroke-linecap="round" stroke-linejoin="round"/></svg></div>
                        <span>Tổng số hộ cận nghèo</span>
                    </div>
                    <div class="stat-value">210,884</div>
                    <span class="stat-pill pill-positive">-1.8% so với năm trước</span>
                </div>
                <div class="stat-card">
                    <div class="stat-head">
                        <div class="nav-icon"><svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M4 12V4l8 4-8 4Z" fill="#22c55e"/></svg></div>
                        <span>Hộ mới thoát nghèo</span>
                    </div>
                    <div class="stat-value">38,120</div>
                    <span class="stat-pill pill-positive">+6.3% hoàn thành</span>
                </div>
                <div class="stat-card">
                    <div class="stat-head">
                        <div class="nav-icon"><svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M3 6.5C3 4.6 4.6 3 6.5 3h3C11.4 3 13 4.6 13 6.5v3C13 11.4 11.4 13 9.5 13h-3C4.6 13 3 11.4 3 9.5v-3Z" stroke="#f59e0b" stroke-width="1.3"/><path d="M6.2 6.3h3.6L8.8 9.7H7.2l-1-3.4Z" fill="#f59e0b"/></svg></div>
                        <span>Hộ nguy cơ tái nghèo</span>
                    </div>
                    <div class="stat-value">14,502</div>
                    <span class="stat-pill pill-warning">+0.4% cần giám sát</span>
                </div>
            </section>

            <section class="panel-grid">
                <div class="panel-column">
                    <div class="panel" id="trendPanel">
                        <div class="panel-toolbar">
                            <div class="panel-title">Xu hướng nghèo theo năm</div>
                            <div class="trend-filters">
                                <select id="trend-scope-select" class="select" aria-label="Chọn phạm vi">
                                    <option value="country">Toàn quốc</option>
                                    <option value="region">Khu vực</option>
                                    <option value="province">Tỉnh</option>
                                </select>
                                <select id="trend-name-select" class="select" aria-label="Chọn khu vực hoặc tỉnh">
                                    <option value="" disabled selected>Chọn khu vực hoặc tỉnh</option>
                                </select>
                            </div>
                        </div>
                    <div class="chart-area">
                        <svg viewBox="0 0 600 260" width="100%" height="220" xmlns="http://www.w3.org/2000/svg">
                            <defs>
                                <linearGradient id="lineBlue" x1="0" x2="0" y1="0" y2="1">
                                    <stop offset="0%" stop-color="#3b82f6" stop-opacity="0.35" />
                                    <stop offset="100%" stop-color="#3b82f6" stop-opacity="0" />
                                </linearGradient>
                                <linearGradient id="lineOrange" x1="0" x2="0" y1="0" y2="1">
                                    <stop offset="0%" stop-color="#f59e0b" stop-opacity="0.35" />
                                    <stop offset="100%" stop-color="#f59e0b" stop-opacity="0" />
                                </linearGradient>
                                <linearGradient id="lineTeal" x1="0" x2="0" y1="0" y2="1">
                                    <stop offset="0%" stop-color="#22c55e" stop-opacity="0.35" />
                                    <stop offset="100%" stop-color="#22c55e" stop-opacity="0" />
                                </linearGradient>
                            </defs>
                            <g stroke="#e5e7eb" stroke-width="1">
                                <line x1="50" y1="40" x2="50" y2="210" />
                                <line x1="50" y1="210" x2="560" y2="210" />
                                <line x1="50" y1="140" x2="560" y2="140" />
                                <line x1="50" y1="90" x2="560" y2="90" />
                            </g>
                            <polyline points="50,190 150,170 250,155 350,145 450,138 560,130" fill="url(#lineBlue)" stroke="#3b82f6" stroke-width="3" stroke-linecap="round" />
                            <polyline points="50,150 150,155 250,145 350,130 450,120 560,110" fill="url(#lineOrange)" stroke="#f59e0b" stroke-width="3" stroke-linecap="round" />
                            <polyline points="50,200 150,185 250,175 350,160 450,150 560,140" fill="url(#lineTeal)" stroke="#22c55e" stroke-width="3" stroke-linecap="round" />
                            <g fill="#94a3b8" font-size="12" font-family="Manrope, sans-serif">
                                <text x="42" y="95">80%</text>
                                <text x="42" y="145">60%</text>
                                <text x="42" y="205">40%</text>
                                <text x="100" y="230">2019</text>
                                <text x="200" y="230">2020</text>
                                <text x="300" y="230">2021</text>
                                <text x="400" y="230">2022</text>
                                <text x="500" y="230">2023</text>
                            </g>
                        </svg>
                    </div>
                    <div class="legend">
                        <span><i style="background:#3b82f6"></i>Hộ nghèo</span>
                        <span><i style="background:#f59e0b"></i>Hộ cận nghèo</span>
                        <span><i style="background:#22c55e"></i>Thoát nghèo</span>
                    </div>
                </div>

                    <div class="panel" id="regionPanel">
                    <div class="panel-toolbar">
                        <div class="panel-title">So sánh giữa các vùng</div>
                        <select id="regionMetricSelect" class="select" aria-label="Chọn loại chỉ số vùng">
                            <option value="poor">Số hộ nghèo</option>
                            <option value="near_poor">Số hộ cận nghèo</option>
                        </select>
                    </div>
                    <div class="chart-area">
                        <svg viewBox="0 0 320 240" width="100%" height="200" xmlns="http://www.w3.org/2000/svg">
                            <g fill="#e5e7eb">
                                <rect x="30" y="30" width="1" height="180" />
                                <rect x="30" y="210" width="260" height="1" />
                            </g>
                            <g fill="#3b82f6">
                                <rect x="55" y="140" width="32" height="70" rx="6" />
                                <rect x="115" y="120" width="32" height="90" rx="6" />
                                <rect x="175" y="90" width="32" height="120" rx="6" />
                                <rect x="235" y="160" width="32" height="50" rx="6" />
                            </g>
                            <g fill="#94a3b8" font-size="12" font-family="Manrope, sans-serif">
                                <text x="58" y="225">Miền Bắc</text>
                                <text x="118" y="225">Miền Trung</text>
                                <text x="178" y="225">Miền Nam</text>
                                <text x="238" y="225">Tây Nguyên</text>
                            </g>
                        </svg>
                    </div>
                    </div>
                </div>
                <div class="panel-placeholder"></div>
            </section>

            <section class="quick-links">
                <a class="link-card" href="./HouseholdList.html">
                    <div>
                        <div class="link-title">Quản lý hộ nghèo</div>
                        <div class="link-desc">Hồ sơ hộ, danh mục và các bước xử lý tiếp theo.</div>
                    </div>
                    <div class="link-icon">HH</div>
                </a>
                <a class="link-card" href="./DataCollection.html">
                    <div>
                        <div class="link-title">Thu thập & cập nhật dữ liệu</div>
                        <div class="link-desc">Khảo sát, xác minh và kiểm tra chất lượng dữ liệu.</div>
                    </div>
                    <div class="link-icon">DT</div>
                </a>
                <a class="link-card" href="./PolicyList.html">
                    <div>
                        <div class="link-title">Chính sách mới</div>
                        <div class="link-desc">Nghị định, hướng dẫn và cập nhật nguồn lực mới.</div>
                    </div>
                    <div class="link-icon">PL</div>
                </a>
                <a class="link-card" href="./GISMap.html">
                    <div>
                        <div class="link-title">Bản đồ nghèo (GIS)</div>
                        <div class="link-desc">Xem phân bố và điểm nóng theo không gian.</div>
                    </div>
                    <div class="link-icon">GIS</div>
                </a>
            </section>

        </main>
    </div>
</div>

<script>
    const API_BASE_URL = sessionStorage.getItem('ipoor_api_base') || 'http://127.0.0.1:8000';
    const TOKEN_STORAGE_KEY = 'ipoor_access_token';
    const DASHBOARD_ENDPOINT = `${API_BASE_URL}/dashboard/summary`;
    const DASHBOARD_FILTERS_ENDPOINT = `${API_BASE_URL}/dashboard/filters`;
    const DASHBOARD_TREND_ENDPOINT = `${API_BASE_URL}/dashboard/trend`;
    const DASHBOARD_KPIS_ENDPOINT = `${API_BASE_URL}/dashboard/kpis`;
    const DASHBOARD_REGIONS_ENDPOINT = `${API_BASE_URL}/dashboard/regions`;
    const USER_PROFILE_ENDPOINT = `${API_BASE_URL}/auth/me`;
    const PERCENT_DIGITS = 1;
    const CHART_TICK_COUNT = 4;
    const CHART_UNIT_LABEL = 'Số hộ';
    const STATUS_UNKNOWN_LABEL = 'Chưa xác định';
    const STATUS_UPDATING_LABEL = 'Đang cập nhật';
    const DEFAULT_ERROR_MESSAGE = 'Không tải được dữ liệu Dashboard';
    const token =
        localStorage.getItem(TOKEN_STORAGE_KEY) ||
        sessionStorage.getItem(TOKEN_STORAGE_KEY);

    if (!token) {
        window.location.href = '../Auth/Login.html';
    }

    const dropdownBtn = document.getElementById('accountDropdown');
    const dropdownMenu = document.getElementById('dropdownMenu');
    const statCards = document.querySelectorAll('.stat-card');
    const trendPanel = document.getElementById('trendPanel');
    const regionPanel = document.getElementById('regionPanel');
    const trendScopeSelect = document.getElementById('trend-scope-select');
    const trendNameSelect = document.getElementById('trend-name-select');
    const kpiScopeSelect = document.getElementById('kpi-scope-select');
    const kpiNameSelect = document.getElementById('kpi-name-select');
    const regionMetricSelect = document.getElementById('regionMetricSelect');
    const userNameEl = document.getElementById('userName');
    const userRoleEl = document.getElementById('userRole');
    let trendRegions = [];
    let trendProvinces = [];
    let activeScope = 'country';
    let activeKpiScope = 'country';
    const roleLabels = {
        admin: 'Quản trị viên',
        province_officer: 'Cán bộ tỉnh',
        district_officer: 'Cán bộ huyện',
        commune_officer: 'Cán bộ xã',
    };

    function closeMenu() {
        dropdownMenu.classList.remove('open');
    }

    dropdownBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        dropdownMenu.classList.toggle('open');
    });

    dropdownMenu.addEventListener('click', (e) => {
        e.stopPropagation();
        if (e.target.dataset.action === 'logout') {
            localStorage.removeItem(TOKEN_STORAGE_KEY);
            sessionStorage.removeItem(TOKEN_STORAGE_KEY);
            window.location.href = '../Auth/Login.html';
        }
        if (e.target.dataset.action === 'change-password') {
            window.location.href = '../Auth/ForgotPassword.html';
        }
        closeMenu();
    });

    document.addEventListener('click', closeMenu);

    function formatNumber(value) {
        if (value === null || value === undefined || Number.isNaN(value)) {
            return 'N/A';
        }
        return Number(value).toLocaleString('vi-VN');
    }

    function formatPercent(value) {
        if (value === null || value === undefined || Number.isNaN(value)) {
            return 'N/A';
        }
        const sign = value > 0 ? '+' : value < 0 ? '' : '';
        return `${sign}${Number(value).toFixed(PERCENT_DIGITS)}%`;
    }

    function formatAxisLabel(value) {
        if (value >= 1000000) {
            return `${(value / 1000000).toFixed(1)}tr`;
        }
        if (value >= 1000) {
            return `${(value / 1000).toFixed(1)}k`;
        }
        return formatNumber(value);
    }

    function buildTicks(maxValue) {
        const ticks = [];
        for (let i = 0; i <= CHART_TICK_COUNT; i += 1) {
            ticks.push((maxValue / CHART_TICK_COUNT) * i);
        }
        return ticks;
    }

    function renderLineChart(container, years, series) {
        const width = Math.max(520, years.length * 70);
        const height = 240;
        const paddingLeft = 48;
        const paddingBottom = 42;
        const paddingTop = 20;
        const paddingRight = 20;
        const maxValue = Math.max(...series.flat(), 1);
        const chartWidth = width - paddingLeft - paddingRight;
        const chartHeight = height - paddingTop - paddingBottom;
        const ticks = buildTicks(maxValue);

        const pointX = (index) =>
            paddingLeft + (chartWidth / Math.max(years.length - 1, 1)) * index;
        const pointY = (value) =>
            paddingTop + (chartHeight - (value / maxValue) * chartHeight);

        const seriesPoints = series.map((values) =>
            values
                .map((value, idx) => `${pointX(idx)},${pointY(value)}`)
                .join(' ')
        );

        const yearLabels = years
            .map(
                (year, idx) =>
                    `<text x="${pointX(idx)}" y="${height - 12}" text-anchor="middle">${year}</text>`
            )
            .join('');

        const tickLines = ticks
            .map((tick) => {
                const y = pointY(tick);
                return `<line x1="${paddingLeft}" y1="${y}" x2="${width - paddingRight}" y2="${y}" />`;
            })
            .join('');

        const tickLabels = ticks
            .map((tick) => {
                const y = pointY(tick);
                return `<text x="${paddingLeft - 8}" y="${y + 4}" text-anchor="end">${formatAxisLabel(tick)}</text>`;
            })
            .join('');

        container.innerHTML = `
            <svg viewBox="0 0 ${width} ${height}" width="${width}" height="220" xmlns="http://www.w3.org/2000/svg">
                <defs>
                    <linearGradient id="lineBlue" x1="0" x2="0" y1="0" y2="1">
                        <stop offset="0%" stop-color="#3b82f6" stop-opacity="0.35" />
                        <stop offset="100%" stop-color="#3b82f6" stop-opacity="0" />
                    </linearGradient>
                    <linearGradient id="lineOrange" x1="0" x2="0" y1="0" y2="1">
                        <stop offset="0%" stop-color="#f59e0b" stop-opacity="0.35" />
                        <stop offset="100%" stop-color="#f59e0b" stop-opacity="0" />
                    </linearGradient>
                    <linearGradient id="lineTeal" x1="0" x2="0" y1="0" y2="1">
                        <stop offset="0%" stop-color="#22c55e" stop-opacity="0.35" />
                        <stop offset="100%" stop-color="#22c55e" stop-opacity="0" />
                    </linearGradient>
                </defs>
                <g stroke="#e5e7eb" stroke-width="1">
                    <line x1="${paddingLeft}" y1="${paddingTop}" x2="${paddingLeft}" y2="${height - paddingBottom}" />
                    <line x1="${paddingLeft}" y1="${height - paddingBottom}" x2="${width - paddingRight}" y2="${height - paddingBottom}" />
                    ${tickLines}
                </g>
                <polyline points="${seriesPoints[0]}" fill="url(#lineBlue)" stroke="#3b82f6" stroke-width="3" stroke-linecap="round" />
                <polyline points="${seriesPoints[1]}" fill="url(#lineOrange)" stroke="#f59e0b" stroke-width="3" stroke-linecap="round" />
                <polyline points="${seriesPoints[2]}" fill="url(#lineTeal)" stroke="#22c55e" stroke-width="3" stroke-linecap="round" />
                <g fill="#94a3b8" font-size="12" font-family="Manrope, sans-serif">
                    ${yearLabels}
                    ${tickLabels}
                    <text x="${paddingLeft}" y="${paddingTop - 6}" text-anchor="start">${CHART_UNIT_LABEL}</text>
                </g>
            </svg>
        `;
    }

    function updateScope(scope) {
        activeScope = scope;
        if (!trendNameSelect) {
            return;
        }
        const isCountry = scope === 'country';
        trendNameSelect.disabled = isCountry;
        const placeholder = isCountry
            ? 'Không cần chọn'
            : scope === 'region'
                ? 'Chọn khu vực'
                : 'Chọn tỉnh';
        trendNameSelect.innerHTML = `<option value="" disabled selected>${placeholder}</option>`;
        if (isCountry) {
            return;
        }
        const source = scope === 'region' ? trendRegions : trendProvinces;
        source.forEach((name) => {
            const option = document.createElement('option');
            option.value = name;
            option.textContent = name;
            trendNameSelect.appendChild(option);
        });
    }

    async function loadTrend(scope, name) {
        const params = new URLSearchParams({ scope });
        if (name) {
            params.set('name', name);
        }
        const res = await fetch(`${DASHBOARD_TREND_ENDPOINT}?${params.toString()}`, {
            headers: { Authorization: `Bearer ${token}` },
        });
        if (res.status === 401) {
            localStorage.removeItem(TOKEN_STORAGE_KEY);
            sessionStorage.removeItem(TOKEN_STORAGE_KEY);
            window.location.href = '../Auth/Login.html';
            return;
        }
        if (!res.ok) {
            return;
        }
        const series = await res.json();
        if (trendPanel) {
            const chartArea = trendPanel.querySelector('.chart-area');
            if (chartArea && series.years && series.years.length) {
                renderLineChart(chartArea, series.years, [
                    series.poor || [],
                    series.near_poor || [],
                    series.exit_poverty || [],
                ]);
            }
        }
    }

    async function loadTrendFilters() {
        const res = await fetch(DASHBOARD_FILTERS_ENDPOINT, {
            headers: { Authorization: `Bearer ${token}` },
        });
        if (res.status === 401) {
            localStorage.removeItem(TOKEN_STORAGE_KEY);
            sessionStorage.removeItem(TOKEN_STORAGE_KEY);
            window.location.href = '../Auth/Login.html';
            return;
        }
        if (!res.ok) {
            return;
        }
        const payload = await res.json();
        trendRegions = payload.regions || [];
        trendProvinces = payload.provinces || [];
    }

    function splitLabel(value) {
        if (!value) return [''];
        if (value.length <= 14) return [value];
        const midpoint = Math.floor(value.length / 2);
        const splitAt = value.lastIndexOf(' ', midpoint);
        if (splitAt <= 0) return [value];
        return [value.slice(0, splitAt), value.slice(splitAt + 1)];
    }

    function renderRegionBars(container, items) {
        const width = 420;
        const height = 260;
        const paddingLeft = 48;
        const paddingBottom = 20;
        const paddingTop = 18;
        const paddingRight = 20;
        const maxValue = Math.max(...items.map((item) => item.value), 1);
        const chartWidth = width - paddingLeft - paddingRight;
        const chartHeight = height - paddingTop - paddingBottom;
        const gap = 18;
        const barWidth = Math.max((chartWidth - gap * (items.length - 1)) / items.length, 24);
        const ticks = buildTicks(maxValue);
        const colors = ['#3b82f6', '#22c55e', '#f59e0b', '#6366f1', '#ef4444', '#14b8a6'];

        const bars = items
            .map((item, idx) => {
                const x = paddingLeft + idx * (barWidth + gap);
                const barHeight = (item.value / maxValue) * chartHeight;
                const y = height - paddingBottom - barHeight;
                const color = colors[idx % colors.length];
                return `<rect x="${x}" y="${y}" width="${barWidth}" height="${barHeight}" rx="6" fill="${color}" />`;
            })
            .join('');

        const tickLines = ticks
            .map((tick) => {
                const y = paddingTop + (chartHeight - (tick / maxValue) * chartHeight);
                return `<line x1="${paddingLeft}" y1="${y}" x2="${width - paddingRight}" y2="${y}" />`;
            })
            .join('');

        const tickLabels = ticks
            .map((tick) => {
                const y = paddingTop + (chartHeight - (tick / maxValue) * chartHeight);
                return `<text x="${paddingLeft - 14}" y="${y + 4}" text-anchor="end">${formatAxisLabel(tick)}</text>`;
            })
            .join('');

        const legend = items
            .map((item, idx) => {
                const color = colors[idx % colors.length];
                return `
                    <div class="bar-legend-item">
                        <span class="bar-legend-swatch" style="background:${color}"></span>
                        <span>${item.label}</span>
                    </div>
                `;
            })
            .join('');

        container.innerHTML = `
            <div class="bar-chart-wrap">
                <svg viewBox="0 0 ${width} ${height}" width="${width}" height="200" xmlns="http://www.w3.org/2000/svg">
                    <g stroke="#e5e7eb" stroke-width="1" fill="none">
                        <line x1="${paddingLeft}" y1="${paddingTop}" x2="${paddingLeft}" y2="${height - paddingBottom}" />
                        <line x1="${paddingLeft}" y1="${height - paddingBottom}" x2="${width - paddingRight}" y2="${height - paddingBottom}" />
                        ${tickLines}
                    </g>
                    ${bars}
                    <g fill="#94a3b8" font-size="13" font-family="Manrope, sans-serif">
                    ${tickLabels}
                    <text x="${paddingLeft}" y="${paddingTop - 4}" text-anchor="start">${CHART_UNIT_LABEL}</text>
                </g>
            </svg>
                <div class="bar-legend">
                    ${legend}
                </div>
            </div>
        `;
    }

    async function loadKpis(scope, name) {
        const params = new URLSearchParams({ scope });
        if (name) {
            params.set('name', name);
        }
        const res = await fetch(`${DASHBOARD_KPIS_ENDPOINT}?${params.toString()}`, {
            headers: { Authorization: `Bearer ${token}` },
        });
        if (res.status === 401) {
            localStorage.removeItem(TOKEN_STORAGE_KEY);
            sessionStorage.removeItem(TOKEN_STORAGE_KEY);
            window.location.href = '../Auth/Login.html';
            return;
        }
        if (!res.ok) {
            return;
        }
        const summary = await res.json();
        if (statCards[0]) {
            statCards[0].querySelector('.stat-value').textContent = formatNumber(summary.poor_total);
            statCards[0].querySelector('.stat-pill').textContent = `${formatPercent(summary.poor_delta_percent)} so với năm trước`;
        }
        if (statCards[1]) {
            statCards[1].querySelector('.stat-value').textContent = formatNumber(summary.near_poor_total);
            statCards[1].querySelector('.stat-pill').textContent = `${formatPercent(summary.near_poor_delta_percent)} so với năm trước`;
        }
        if (statCards[2]) {
            statCards[2].querySelector('.stat-value').textContent = formatNumber(summary.exit_poverty_total);
            statCards[2].querySelector('.stat-pill').textContent = '';
        }
        if (statCards[3]) {
            statCards[3].querySelector('.stat-value').textContent = summary.at_risk_total === null
                ? STATUS_UNKNOWN_LABEL
                : formatNumber(summary.at_risk_total);
            statCards[3].querySelector('.stat-pill').textContent = STATUS_UPDATING_LABEL;
        }
    }

    async function loadRegionChart(metric) {
        if (!regionPanel) {
            return;
        }
        const chartArea = regionPanel.querySelector('.chart-area');
        if (!chartArea) {
            return;
        }
        const params = new URLSearchParams();
        if (metric) {
            params.set('metric', metric);
        }
        const res = await fetch(`${DASHBOARD_REGIONS_ENDPOINT}?${params.toString()}`, {
            headers: { Authorization: `Bearer ${token}` },
        });
        if (res.status === 401) {
            localStorage.removeItem(TOKEN_STORAGE_KEY);
            sessionStorage.removeItem(TOKEN_STORAGE_KEY);
            window.location.href = '../Auth/Login.html';
            return;
        }
        if (!res.ok) {
            return;
        }
        const items = await res.json();
        renderRegionBars(chartArea, items);
    }

    async function loadUserProfile() {
        const res = await fetch(USER_PROFILE_ENDPOINT, {
            headers: { Authorization: `Bearer ${token}` },
        });
        if (res.status === 401) {
            localStorage.removeItem(TOKEN_STORAGE_KEY);
            sessionStorage.removeItem(TOKEN_STORAGE_KEY);
            window.location.href = '../Auth/Login.html';
            return;
        }
        if (!res.ok) {
            return;
        }
        const profile = await res.json();
        if (userNameEl) {
            userNameEl.textContent = profile.full_name || profile.email || 'N/A';
        }
        if (userRoleEl) {
            userRoleEl.textContent = roleLabels[profile.role] || profile.role || 'N/A';
        }
    }

    async function loadDashboard() {
        if (!token) {
            window.location.href = '../Auth/Login.html';
            return;
        }
        try {
            const res = await fetch(DASHBOARD_ENDPOINT, {
                headers: { Authorization: `Bearer ${token}` },
            });
            if (res.status === 401) {
                localStorage.removeItem(TOKEN_STORAGE_KEY);
                sessionStorage.removeItem(TOKEN_STORAGE_KEY);
                window.location.href = '../Auth/Login.html';
                return;
            }
            if (!res.ok) {
                throw new Error(DEFAULT_ERROR_MESSAGE);
            }
            const summary = await res.json();

            if (regionPanel && summary.top_regions) {
                const chartArea = regionPanel.querySelector('.chart-area');
                if (chartArea) {
                    renderRegionBars(chartArea, summary.top_regions);
                }
            }
        } catch (error) {
            const message = error?.message || DEFAULT_ERROR_MESSAGE;
            statCards.forEach((card) => {
                const valueEl = card.querySelector('.stat-value');
                const pillEl = card.querySelector('.stat-pill');
                if (valueEl) {
                    valueEl.textContent = 'N/A';
                }
                if (pillEl) {
                    pillEl.textContent = message;
                }
            });
        }
    }

    if (trendScopeSelect) {
        trendScopeSelect.addEventListener('change', () => {
            const scope = trendScopeSelect.value || 'country';
            updateScope(scope);
            if (scope === 'country') {
                loadTrend('country');
            }
        });
    }

    if (trendNameSelect) {
        trendNameSelect.addEventListener('change', () => {
            const value = trendNameSelect.value;
            if (!value) return;
            loadTrend(activeScope, value);
        });
    }

    if (kpiScopeSelect) {
        kpiScopeSelect.addEventListener('change', () => {
            const scope = kpiScopeSelect.value || 'country';
            activeKpiScope = scope;
            if (kpiNameSelect) {
                kpiNameSelect.disabled = scope === 'country';
                const placeholder = scope === 'country'
                    ? 'Không cần chọn'
                    : scope === 'region'
                        ? 'Chọn khu vực'
                        : 'Chọn tỉnh';
                kpiNameSelect.innerHTML = `<option value="" disabled selected>${placeholder}</option>`;
                if (scope !== 'country') {
                    const source = scope === 'region' ? trendRegions : trendProvinces;
                    source.forEach((name) => {
                        const option = document.createElement('option');
                        option.value = name;
                        option.textContent = name;
                        kpiNameSelect.appendChild(option);
                    });
                }
            }
            if (scope === 'country') {
                loadKpis('country');
            }
        });
    }

    if (kpiNameSelect) {
        kpiNameSelect.addEventListener('change', () => {
            const value = kpiNameSelect.value;
            if (!value) return;
            loadKpis(activeKpiScope, value);
        });
    }

    if (regionMetricSelect) {
        regionMetricSelect.addEventListener('change', () => {
            const metric = regionMetricSelect.value || 'poor';
            loadRegionChart(metric);
        });
    }

    updateScope('country');
    loadTrendFilters().then(() => {
        updateScope(activeScope);
        if (kpiScopeSelect) {
            kpiScopeSelect.value = 'country';
        }
        if (kpiNameSelect) {
            kpiNameSelect.disabled = true;
            kpiNameSelect.innerHTML = '<option value="" disabled selected>Không cần chọn</option>';
        }
        loadTrend('country');
        loadKpis('country');
        if (regionMetricSelect) {
            regionMetricSelect.value = 'poor';
        }
        loadRegionChart('poor');
    });
    loadUserProfile();
    loadDashboard();
</script>
</body>
</html>




