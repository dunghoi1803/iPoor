<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iPOOR | Chi tiết chính sách</title>
    <link rel="icon" type="image/png" href="../Image/icon.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --navy-900: #0f172a;
            --navy-800: #162544;
            --navy-700: #1f2f54;
            --blue-500: #3b82f6;
            --blue-300: #60a5fa;
            --blue-100: #e1ecff;
            --orange-400: #f59e0b;
            --gray-50: #f5f7fa;
            --gray-100: #e5e7eb;
            --gray-200: #e2e8f0;
            --gray-400: #94a3b8;
            --gray-500: #6b7280;
            --white: #ffffff;
            --card-shadow: 0 10px 30px rgba(15, 23, 42, 0.08);
            --tag-policy: #eef2ff;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Manrope', system-ui, -apple-system, sans-serif; background: var(--gray-50); color: var(--navy-900); }

        .app-shell { display: grid; grid-template-columns: 260px 1fr; min-height: 100vh; }
        .sidebar { background: var(--navy-900); color: var(--white); display: flex; flex-direction: column; padding: 20px 18px; }
        .brand { display: flex; align-items: center; gap: 12px; padding: 10px 12px 20px; }
        .brand-mark { width: 44px; height: 44px; border-radius: 12px; background: var(--white); display: grid; place-items: center; }
        .brand-logo { width: 30px; height: 30px; object-fit: contain; }
        .brand-name { font-size: 18px; font-weight: 700; letter-spacing: 0.4px; }

        nav { margin-top: 8px; display: grid; gap: 6px; }
        .nav-item { display: flex; align-items: center; gap: 12px; padding: 12px 14px; border-radius: 10px; color: var(--white); text-decoration: none; transition: background 0.2s, transform 0.1s; }
        .nav-item:hover { background: var(--navy-800); transform: translateX(2px); }
        .nav-item.active { background: var(--navy-700); border-left: 3px solid var(--blue-500); }
        .nav-icon { width: 16px; height: 16px; display: inline-flex; align-items: center; justify-content: center; }

        main { background: linear-gradient(135deg, #f8fbff 0%, #f4f5fb 100%); padding: 24px 28px; }
        .page-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 18px; gap: 12px; }
        .meta { display: flex; flex-wrap: wrap; gap: 12px; color: var(--gray-500); margin-top: 6px; }
        .tag { padding: 6px 10px; border-radius: 999px; font-weight: 700; font-size: 12px; background: var(--tag-policy); color: #4338ca; }

        .actions { display: flex; gap: 10px; }
        .btn-primary { padding: 11px 14px; border-radius: 10px; border: none; background: linear-gradient(90deg, var(--blue-500), var(--blue-300)); color: var(--white); font-weight: 700; cursor: pointer; box-shadow: 0 12px 22px rgba(59, 130, 246, 0.3); }
        .btn-ghost { padding: 10px 12px; border-radius: 10px; border: 1px solid var(--gray-200); background: var(--white); color: var(--navy-900); font-weight: 700; cursor: pointer; }

        .article { background: var(--white); border: 1px solid var(--gray-100); border-radius: 16px; box-shadow: var(--card-shadow); padding: 20px; display: grid; gap: 14px; }
        .article p { color: var(--gray-500); line-height: 1.7; }
        .article h2, .article h3 { font-size: 20px; margin-top: 6px; }
        .article ul, .article ol { margin-left: 18px; color: var(--gray-500); line-height: 1.6; display: grid; gap: 6px; }
        .article .list-dash, .article .list-plus { list-style: none; padding-left: 0; }
        .article .list-dash li::before { content: "– "; color: var(--navy-900); font-weight: 700; }
        .article .list-plus li::before { content: "+ "; color: var(--navy-900); font-weight: 700; }
        .article .list-circle { list-style-type: circle; }
        .article .list-alpha { list-style-type: lower-alpha; }
        .article .list-roman { list-style-type: lower-roman; }
        .article figure { margin: 0; display: grid; gap: 8px; }
        .article figure img { width: 100%; border-radius: 12px; }
        .article figcaption { color: var(--gray-500); font-size: 13px; }
        .article blockquote { border-left: 3px solid var(--blue-300); padding-left: 12px; color: var(--gray-500); font-style: italic; display: grid; gap: 6px; }
        .article blockquote cite { font-style: normal; font-weight: 700; color: var(--navy-900); }
        .article table { width: 100%; border-collapse: collapse; }
        .article th, .article td { border: 1px solid var(--gray-200); padding: 8px 10px; text-align: left; }
        .article th { background: #f8fafc; }
        .article .embed { position: relative; width: 100%; padding-top: 56.25%; border-radius: 12px; overflow: hidden; background: #0f172a; }
        .article .embed iframe { position: absolute; inset: 0; width: 100%; height: 100%; border: 0; }
        .article hr { border: none; border-top: 1px solid var(--gray-200); margin: 8px 0; }
        .meta-block { display: grid; gap: 8px; padding: 12px; border: 1px solid var(--gray-100); border-radius: 12px; background: #f8fafc; }
        .meta-line { display: flex; gap: 8px; color: var(--gray-500); font-weight: 600; }
        .meta-label { color: var(--navy-900); min-width: 130px; }
        .tag-list { display: flex; flex-wrap: wrap; gap: 8px; }
        .tag-chip { background: var(--tag-policy); color: #4338ca; border-radius: 999px; padding: 6px 10px; font-weight: 700; font-size: 12px; }

        .attachments { margin-top: 6px; display: grid; gap: 10px; }
        .attachment { display: flex; align-items: center; gap: 10px; padding: 12px 14px; border: 1px dashed var(--gray-200); border-radius: 12px; background: #fff7ed; }
        .attachment a { font-weight: 700; color: #ea580c; text-decoration: none; }

        @media (max-width: 1024px) {
            .app-shell { grid-template-columns: 1fr; }
            .sidebar { flex-direction: row; overflow-x: auto; height: 72px; }
            nav { grid-auto-flow: column; grid-auto-columns: max-content; align-items: center; }
            .page-header { flex-direction: column; align-items: flex-start; }
            .actions { width: 100%; }
            .btn-primary, .btn-ghost { width: fit-content; }
        }
    </style>
</head>
<body>
<div class="app-shell">
    <aside class="sidebar">
        <div class="brand">
            <div class="brand-mark"><img class="brand-logo" src="../Image/icon.png" alt="Logo"></div>
            <div class="brand-name">iPOOR</div>
        </div>
                <nav>
            <a class="nav-item" href="../LandingPage/index.html">
                <span class="nav-icon"><svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M2 7.5 8 2l6 5.5V14H9.5v-3h-3v3H2V7.5Z" fill="white" opacity="0.9"/></svg></span>
                <span>Trang giới thiệu</span>
            </a>
            <a class="nav-item" href="./HomePage.html">
                <span class="nav-icon"><svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M8 2a6 6 0 0 0-6 6v2.5A1.5 1.5 0 0 0 3.5 12h9A1.5 1.5 0 0 0 14 10.5V8a6 6 0 0 0-6-6Z" stroke="white" stroke-width="1.3"/><path d="M8 8 10.8 6.2" stroke="white" stroke-width="1.3" stroke-linecap="round"/><circle cx="8" cy="8" r="1" fill="white"/></svg></span>
                <span>Dashboard</span>
            </a>
            <a class="nav-item" href="./HouseholdList.html">
                <span class="nav-icon"><svg width="16" height="16" viewBox="0 0 16 16" fill="none"><rect x="2" y="3" width="12" height="10" rx="2" stroke="white" stroke-width="1.4"/><path d="M5 3v10" stroke="white" stroke-width="1.2" opacity="0.7"/><circle cx="11" cy="7" r="1" fill="white"/></svg></span>
                <span>Quản lý hộ nghèo</span>
            </a>
            <a class="nav-item" href="./DataCollection.html">
                <span class="nav-icon"><svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M2.5 5.5h11v1.5h-11V5.5Zm0 3h7v1.5h-7V8.5Zm0 3h5v1.5h-5V11.5Z" fill="white" opacity="0.9"/><path d="M10.5 3v10" stroke="white" stroke-width="1.2" opacity="0.7"/></svg></span>
                <span>Thu thập & cập nhật dữ liệu</span>
            </a>
            <a class="nav-item active" href="./PolicyList.html">
                <span class="nav-icon"><svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M3 13V3h10v10H3Z" stroke="white" stroke-width="1.3"/><path d="M5 6.5h6M5 9h3.5" stroke="white" stroke-width="1.2" stroke-linecap="round"/></svg></span>
                <span>Chính sách & báo cáo</span>
            </a>
            <a class="nav-item" href="./GISMap.html">
                <span class="nav-icon"><svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M2.7 7.3c0-2.5 2-4.5 4.5-4.5s4.5 2 4.5 4.5-2 4.5-4.5 4.5c-.7 0-1.3-.15-1.9-.44l-2.05.58.55-1.95c-.36-.62-.6-1.34-.6-2.09Z" stroke="white" stroke-width="1.3"/><path d="M6.5 6.8c0-.7.6-1.2 1.2-1.2.7 0 1.2.5 1.2 1.2 0 .6-.5 1.2-1.2 1.2-.7 0-1.2-.6-1.2-1.2Z" fill="white"/></svg></span>
                <span>Bản đồ nghèo (GIS)</span>
            </a>
            <a class="nav-item" href="./ActivityLogs.html">
                <span class="nav-icon"><svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M4.5 3.5h7m-7 9h7M8 1.5v2m0 9v2M5.5 6h5L9.8 10H6.2L5.5 6Z" stroke="white" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/></svg></span>
                <span>Nhật ký hoạt động</span>
            </a>
        </nav>
    </aside>

    <main>
        <div class="page-header">
            <div>
                <h1 id="title">Đang tải...</h1>
                <div class="meta">
                    <span class="tag" id="categoryTag">Chính sách</span>
                    <span id="postedDate">Ngày đăng: -</span>
                    <span id="author">Tác giả: -</span>
                </div>
            </div>
            <div class="actions">
                <a class="btn-ghost" href="./PolicyForm.html?mode=edit" id="editLink">Sửa bài</a>
                <button class="btn-primary" type="button" id="deleteBtn">Xóa bài</button>
            </div>
        </div>

        <article class="article">
            <div class="meta-block">
                <div class="meta-line"><span class="meta-label">Tóm tắt:</span><span id="summary">-</span></div>
                <div class="meta-line"><span class="meta-label">Công khai:</span><span id="isPublic">-</span></div>
                <div class="tag-list" id="tags"></div>
            </div>
            <div id="content">Đang tải nội dung...</div>
            <div class="attachments" id="attachments"></div>
        </article>
    </main>
</div>

<script>
    const API_BASE_URL = sessionStorage.getItem('ipoor_api_base') || 'http://127.0.0.1:8000';
    const TOKEN_STORAGE_KEY = 'ipoor_access_token';
    const POLICY_SELECTED_KEY = 'ipoor_policy_selected_id';
    const POLICY_CACHE_KEY = 'ipoor_policy_cache';
    const typeLabels = {
        decree: { text: 'Chính sách', cls: 'tag' },
        circular: { text: 'Chính sách', cls: 'tag' },
        policy: { text: 'Chính sách', cls: 'tag' },
        report: { text: 'Báo cáo', cls: 'tag report' },
        guideline: { text: 'Hướng dẫn', cls: 'tag' },
        guide: { text: 'Hướng dẫn', cls: 'tag' },
        other: { text: 'Khác', cls: 'tag' },
    };

    const titleEl = document.getElementById('title');
    const categoryTag = document.getElementById('categoryTag');
    const postedDate = document.getElementById('postedDate');
    const author = document.getElementById('author');
    const content = document.getElementById('content');
    const attachments = document.getElementById('attachments');
    const deleteBtn = document.getElementById('deleteBtn');
    const editLink = document.getElementById('editLink');
    const summaryEl = document.getElementById('summary');
    const isPublicEl = document.getElementById('isPublic');
    const tagsEl = document.getElementById('tags');
    const PUBLIC_LABEL = 'Có';
    const PRIVATE_LABEL = 'Không';

    function getToken() {
        return localStorage.getItem(TOKEN_STORAGE_KEY) || sessionStorage.getItem(TOKEN_STORAGE_KEY);
    }

    function mapCategory(category) {
        return typeLabels[category] || typeLabels.other;
    }

    function normalizeAttachmentUrl(value) {
        if (!value) return '';
        if (value.startsWith('http://') || value.startsWith('https://')) return value;
        if (value.startsWith('/')) return `${API_BASE_URL}${value}`;
        return value;
    }

    function formatDate(value) {
        if (!value) return 'Ngày đăng: -';
        const d = new Date(value);
        return `Ngày đăng: ${isNaN(d.getTime()) ? '-' : d.toLocaleDateString('vi-VN')}`;
    }

    function sanitizeHtml(input) {
        const template = document.createElement('template');
        template.innerHTML = input || '';
        const allowedTags = new Set(['B', 'STRONG', 'I', 'EM', 'U', 'A', 'MARK', 'BR', 'SPAN']);
        const allowedAttrs = {
            A: new Set(['href', 'target', 'rel']),
        };
        const walker = document.createTreeWalker(template.content, NodeFilter.SHOW_ELEMENT);
        const nodesToRemove = [];
        while (walker.nextNode()) {
            const node = walker.currentNode;
            if (!allowedTags.has(node.tagName)) {
                nodesToRemove.push(node);
                continue;
            }
            const attrs = Array.from(node.attributes);
            attrs.forEach((attr) => {
                const allowed = allowedAttrs[node.tagName];
                if (!allowed || !allowed.has(attr.name)) {
                    node.removeAttribute(attr.name);
                }
            });
            if (node.tagName === 'A') {
                node.setAttribute('rel', 'noopener');
                node.setAttribute('target', '_blank');
            }
        }
        nodesToRemove.forEach((node) => {
            const text = document.createTextNode(node.textContent || '');
            node.replaceWith(text);
        });
        return template.innerHTML;
    }

    function renderList(items, listStyle, ordered, level = 0) {
        const style = listStyle || (ordered ? 'decimal' : 'disc');
        const listClass = {
            dash: 'list-dash',
            plus: 'list-plus',
            circle: 'list-circle',
            'lower-alpha': 'list-alpha',
            'lower-roman': 'list-roman',
        }[style] || '';
        const tag = ordered ? 'ol' : 'ul';
        const nestedStyle = level > 0 && !ordered ? 'circle' : style;
        const nestedClass = {
            dash: 'list-dash',
            plus: 'list-plus',
            circle: 'list-circle',
            'lower-alpha': 'list-alpha',
            'lower-roman': 'list-roman',
        }[nestedStyle] || '';
        const className = level > 0 ? nestedClass : listClass;
        const liItems = items.map((item) => {
            if (typeof item === 'string') {
                return `<li>${sanitizeHtml(item)}</li>`;
            }
            const content = sanitizeHtml(item.content || '');
            const children = Array.isArray(item.items) && item.items.length
                ? renderList(item.items, nestedStyle, ordered, level + 1)
                : '';
            return `<li>${content}${children}</li>`;
        }).join('');
        return `<${tag} class="${className}">${liItems}</${tag}>`;
    }

    function renderBlocks(blockData) {
        if (!blockData || !Array.isArray(blockData.blocks)) return '';
        return blockData.blocks.map((block) => {
            if (!block || !block.data) return '';
            const alignment = block.data.alignment || '';
            const alignStyle = alignment ? ` style="text-align:${alignment}"` : '';
            if (block.type === 'header') {
                const level = Math.min(Math.max(block.data.level || 3, 2), 3);
                return `<h${level}${alignStyle}>${sanitizeHtml(block.data.text || '')}</h${level}>`;
            }
            if (block.type === 'paragraph') {
                return `<p${alignStyle}>${sanitizeHtml(block.data.text || '')}</p>`;
            }
            if (block.type === 'quote') {
                const quote = sanitizeHtml(block.data.text || '');
                const caption = sanitizeHtml(block.data.caption || '');
                return `<blockquote${alignStyle}><p>${quote}</p>${caption ? `<cite>${caption}</cite>` : ''}</blockquote>`;
            }
            if (block.type === 'list' || block.type === 'nestedList') {
                const items = block.data.items || [];
                const ordered = block.data.style === 'ordered';
                const listHtml = renderList(items, block.data.listStyle, ordered);
                return alignStyle ? `<div${alignStyle}>${listHtml}</div>` : listHtml;
            }
            if (block.type === 'image') {
                const url = normalizeAttachmentUrl(block.data.file?.url || '');
                const caption = sanitizeHtml(block.data.caption || '');
                if (!url) return '';
                return `<figure${alignStyle}><img src="${url}" alt="${caption}" loading="lazy">${caption ? `<figcaption>${caption}</figcaption>` : ''}</figure>`;
            }
            if (block.type === 'delimiter') {
                return `<hr${alignStyle}>`;
            }
            if (block.type === 'table') {
                const rows = Array.isArray(block.data.content) ? block.data.content : [];
                if (!rows.length) return '';
                const withHeadings = Boolean(block.data.withHeadings);
                const headerCells = withHeadings
                    ? rows[0].map((cell) => `<th>${sanitizeHtml(cell)}</th>`).join('')
                    : '';
                const bodyRows = (withHeadings ? rows.slice(1) : rows).map((row) => {
                    const cells = row.map((cell) => `<td>${sanitizeHtml(cell)}</td>`).join('');
                    return `<tr>${cells}</tr>`;
                }).join('');
                const headHtml = withHeadings ? `<thead><tr>${headerCells}</tr></thead>` : '';
                return `<table${alignStyle}>${headHtml}<tbody>${bodyRows}</tbody></table>`;
            }
            if (block.type === 'embed') {
                const embedUrl = block.data.embed || '';
                if (!embedUrl) return '';
                return `<div class="embed"${alignStyle}><iframe src="${embedUrl}" loading="lazy" allowfullscreen></iframe></div>`;
            }
            return '';
        }).join('');
    }

    function render(policy) {
        titleEl.textContent = policy.title || 'Không có tiêu đề';
        const mapped = mapCategory(policy.category || policy.type || 'other');
        categoryTag.textContent = mapped.text;
        categoryTag.className = mapped.cls;
        postedDate.textContent = formatDate(policy.updated_at || policy.created_at);
        author.textContent = `Tác giả: ${policy.issued_by || 'N/A'}`;
        const blocksHtml = renderBlocks(policy.content_blocks);
        if (blocksHtml) {
            content.innerHTML = blocksHtml;
        } else {
            content.innerHTML = `<p>${policy.description || 'Chưa có nội dung chi tiết.'}</p>`;
        }
        summaryEl.textContent = policy.summary || '-';
        isPublicEl.textContent = typeof policy.is_public === 'boolean' ? (policy.is_public ? PUBLIC_LABEL : PRIVATE_LABEL) : '-';
        tagsEl.innerHTML = '';
        (policy.tags || []).forEach((tag) => {
            const chip = document.createElement('span');
            chip.className = 'tag-chip';
            chip.textContent = tag;
            tagsEl.appendChild(chip);
        });
        attachments.innerHTML = '';
        const attachmentUrl = normalizeAttachmentUrl(policy.attachment_url || '');
        if (attachmentUrl) {
            const block = document.createElement('div');
            block.className = 'attachment';
            block.innerHTML = `<svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M4 2h6l3 3v9H4V2Z" stroke="#ea580c" stroke-width="1.2"/><path d="M10 2v3h3" stroke="#ea580c" stroke-width="1.2"/><path d="M5.5 9.5h1m3 0H11M8 9.5V13" stroke="#ea580c" stroke-width="1.1" stroke-linecap="round"/></svg>\n                <a href="${attachmentUrl}" target="_blank" rel="noopener">Tải tài liệu</a>`;
            attachments.appendChild(block);
        }
    }

    function getCached(id) {
        const raw = sessionStorage.getItem(POLICY_CACHE_KEY);
        if (!raw) return null;
        try {
            const cache = JSON.parse(raw);
            return cache[id] || null;
        } catch (e) {
            return null;
        }
    }

    async function loadDetail() {
        const token = getToken();
        if (!token) {
            window.location.href = '../Auth/Login.html';
            return;
        }
        let id = new URLSearchParams(window.location.search).get('id') || sessionStorage.getItem(POLICY_SELECTED_KEY);
        if (!id) {
            const raw = sessionStorage.getItem(POLICY_CACHE_KEY);
            if (raw) {
                try {
                    const cache = JSON.parse(raw);
                    const firstId = Object.keys(cache)[0];
                    if (firstId) {
                        sessionStorage.setItem(POLICY_SELECTED_KEY, firstId);
                        window.location.href = `./PolicyDetail.html?id=${firstId}`;
                        return;
                    }
                } catch (_) { /* ignore */ }
            }
            titleEl.textContent = 'Không tìm thấy bài viết';
            return;
        }

        try {
            const res = await fetch(`${API_BASE_URL}/policies/${id}`, {
                headers: { Authorization: `Bearer ${token}` },
            });
            if (res.status === 401) {
                localStorage.removeItem(TOKEN_STORAGE_KEY);
                sessionStorage.removeItem(TOKEN_STORAGE_KEY);
                window.location.href = '../Auth/Login.html';
                return;
            }
            if (res.status === 404) {
                titleEl.textContent = 'Không tìm thấy bài viết';
                content.textContent = '';
                return;
            }
            if (!res.ok) throw new Error('Không tải được chính sách');
            const data = await res.json();
            render(data);
            editLink.href = `./PolicyForm.html?mode=edit&id=${id}`;
            deleteBtn.addEventListener('click', () => deletePolicy(id));
        } catch (error) {
            titleEl.textContent = error.message;
            content.textContent = '';
        }
    }

    async function deletePolicy(id) {
        const token = getToken();
        if (!confirm('Bạn chắc chắn muốn xóa tài liệu này?')) return;
        try {
            const res = await fetch(`${API_BASE_URL}/policies/${id}`, {
                method: 'DELETE',
                headers: { Authorization: `Bearer ${token}` },
            });
            if (!res.ok) throw new Error('Xóa không thành công');
            window.location.href = './PolicyList.html';
        } catch (error) {
            alert(error.message);
        }
    }

    loadDetail();
</script>
</body>
</html>




