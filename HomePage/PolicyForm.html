<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iPOOR | Biên tập bài viết</title>
    <link rel="icon" type="image/png" href="../Image/icon.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --navy-900: #0f172a;
            --navy-800: #162544;
            --navy-700: #1f2f54;
            --blue-500: #3b82f6;
            --blue-300: #60a5fa;
            --blue-100: #e1ecff;
            --gray-50: #f5f7fa;
            --gray-100: #e5e7eb;
            --gray-200: #e2e8f0;
            --gray-300: #cbd5e1;
            --gray-400: #94a3b8;
            --gray-500: #6b7280;
            --white: #ffffff;
            --card-shadow: 0 12px 32px rgba(15, 23, 42, 0.08);
            --radius-lg: 16px;
            --radius-md: 12px;
            --danger: #dc2626;
            --success: #16a34a;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Manrope', system-ui, -apple-system, sans-serif; background: var(--gray-50); color: var(--navy-900); }

        .app-shell { display: grid; grid-template-columns: 260px 1fr; min-height: 100vh; }
        .sidebar { background: var(--navy-900); color: var(--white); display: flex; flex-direction: column; padding: 20px 18px; }
        .brand { display: flex; align-items: center; gap: 12px; padding: 10px 12px 20px; }
        .brand-mark { width: 44px; height: 44px; border-radius: 12px; background: var(--white); display: grid; place-items: center; }
        .brand-logo { width: 30px; height: 30px; object-fit: contain; }
        .brand-name { font-size: 18px; font-weight: 700; letter-spacing: 0.4px; }

        nav { margin-top: 8px; display: grid; gap: 6px; }
        .nav-item { display: flex; align-items: center; gap: 12px; padding: 12px 14px; border-radius: 10px; color: var(--white); text-decoration: none; transition: background 0.2s, transform 0.1s; }
        .nav-item:hover { background: var(--navy-800); transform: translateX(2px); }
        .nav-item.active { background: var(--navy-700); border-left: 3px solid var(--blue-500); }
        .nav-icon { width: 16px; height: 16px; display: inline-flex; align-items: center; justify-content: center; }

        main { background: linear-gradient(135deg, #f8fbff 0%, #f4f5fb 100%); padding: 24px 28px 34px; }
        .page-header { display: flex; align-items: center; justify-content: space-between; gap: 12px; margin-bottom: 20px; }
        .page-header h1 { font-size: 26px; }
        .page-header p { color: var(--gray-500); }

        .card { background: var(--white); border: 1px solid var(--gray-100); border-radius: var(--radius-lg); box-shadow: var(--card-shadow); padding: 18px 18px 20px; display: grid; gap: 14px; }
        .card-title { font-size: 18px; font-weight: 700; }

        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 14px; }
        .form-group { display: grid; gap: 6px; }
        label { font-weight: 700; color: var(--navy-900); }
        input, select, textarea { width: 100%; padding: 11px 12px; border-radius: 12px; border: 1px solid var(--gray-200); font-weight: 600; color: var(--navy-900); background: var(--white); }
        textarea { min-height: 110px; resize: vertical; }
        .helper { color: var(--gray-500); font-size: 13px; }
        .error { color: var(--danger); font-size: 13px; }
        .invalid { border-color: var(--danger); }

        .tag-input { display: flex; flex-wrap: wrap; gap: 6px; padding: 8px; border: 1px solid var(--gray-200); border-radius: 12px; background: var(--white); }
        .tag-chip { display: inline-flex; align-items: center; gap: 6px; background: #e0f2fe; color: #075985; border-radius: 999px; padding: 6px 10px; font-weight: 700; }
        .tag-chip button { border: none; background: transparent; cursor: pointer; color: inherit; font-weight: 700; }
        .tag-input input { flex: 1; min-width: 160px; border: none; padding: 6px 4px; outline: none; font-weight: 600; }

        .editor-card { min-height: 480px; }
        .toolbar { display: flex; flex-wrap: wrap; gap: 8px; padding: 10px; background: #f8fafc; border: 1px solid var(--gray-200); border-radius: 12px; }
        .tool-btn { padding: 8px 10px; border-radius: 10px; border: 1px solid var(--gray-200); background: var(--white); cursor: pointer; font-weight: 700; color: var(--navy-900); }
        .tool-btn:hover { border-color: var(--blue-300); color: var(--blue-500); }
        .editor { border: 1px solid var(--gray-200); border-radius: var(--radius-md); padding: 14px; min-height: 420px; background: var(--white); overflow: auto; line-height: 1.7; }
        .editor ul, .editor ol { margin-left: 20px; padding-left: 18px; }
        .editor.empty::before { content: attr(data-placeholder); color: var(--gray-400); }

        .dropzone { border: 2px dashed var(--gray-300); border-radius: var(--radius-md); padding: 24px; text-align: center; background: #f8fafc; cursor: pointer; transition: border-color 0.15s ease, background 0.15s ease; }
        .dropzone:hover { border-color: var(--blue-500); background: #eef2ff; }
        .dropzone input { display: none; }
        .dropzone h4 { margin-bottom: 6px; }
        .dropzone p { color: var(--gray-500); }

        .file-list { display: grid; gap: 10px; margin-top: 10px; }
        .file-item { display: flex; align-items: center; justify-content: space-between; gap: 10px; padding: 12px 14px; border: 1px solid var(--gray-200); border-radius: 12px; background: var(--white); }
        .file-meta { display: flex; align-items: center; gap: 10px; color: var(--navy-900); font-weight: 700; }
        .file-meta small { color: var(--gray-500); font-weight: 600; }
        .icon-pdf { width: 28px; height: 28px; border-radius: 8px; background: #fff1e6; display: grid; place-items: center; color: #ea580c; font-weight: 800; }
        .icon-trash { background: transparent; border: 1px solid var(--gray-200); border-radius: 10px; padding: 8px 10px; cursor: pointer; font-weight: 700; color: var(--danger); }

        .toggle-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px; }
        .checkbox { display: flex; align-items: center; gap: 10px; }
        .checkbox input { width: 18px; height: 18px; }

        .footer-actions { margin-top: 22px; display: flex; justify-content: flex-end; gap: 12px; }
        .btn-primary { padding: 12px 16px; border-radius: 12px; background: var(--navy-900); color: var(--white); border: none; font-weight: 700; cursor: pointer; box-shadow: 0 12px 24px rgba(15, 23, 42, 0.25); }
        .btn-secondary { padding: 12px 16px; border-radius: 12px; background: var(--white); color: var(--navy-900); border: 1px solid var(--blue-500); font-weight: 700; cursor: pointer; }
        .btn-ghost { padding: 12px 14px; border-radius: 12px; background: var(--white); color: var(--gray-500); border: 1px solid var(--gray-200); font-weight: 700; cursor: pointer; }

        .toast { position: fixed; bottom: 20px; right: 20px; padding: 14px 18px; background: var(--success); color: var(--white); border-radius: 12px; box-shadow: 0 8px 20px rgba(22, 163, 74, 0.4); display: none; font-weight: 700; }

        @media (max-width: 1024px) {
            .app-shell { grid-template-columns: 1fr; }
            .sidebar { flex-direction: row; overflow-x: auto; height: 72px; }
            nav { grid-auto-flow: column; grid-auto-columns: max-content; align-items: center; }
            .page-header { flex-direction: column; align-items: flex-start; }
            .page-header h1 { font-size: 22px; }
            .footer-actions { flex-wrap: wrap; }
        }
    </style>
</head>
<body>
<div class="app-shell">
    <aside class="sidebar">
        <div class="brand">
            <div class="brand-mark"><img class="brand-logo" src="../Image/icon.png" alt="Logo"></div>
            <div class="brand-name">iPOOR</div>
        </div>
        <nav>
            <a class="nav-item" href="../LandingPage/index.html">
                <span class="nav-icon"><svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M2 7.5 8 2l6 5.5V14H9.5v-3h-3v3H2V7.5Z" fill="white" opacity="0.9"/></svg></span>
                <span>Trang giới thiệu</span>
            </a>
            <a class="nav-item" href="./HomePage.html">
                <span class="nav-icon"><svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M2 7.5 8 2l6 5.5V14H9.5v-3h-3v3H2V7.5Z" fill="white" opacity="0.9"/></svg></span>
                <span>Bảng điều khiển</span>
            </a>
            <a class="nav-item" href="./HouseholdList.html">
                <span class="nav-icon"><svg width="16" height="16" viewBox="0 0 16 16" fill="none"><rect x="2" y="3" width="12" height="10" rx="2" stroke="white" stroke-width="1.4"/><path d="M5 3v10" stroke="white" stroke-width="1.2" opacity="0.7"/><circle cx="11" cy="7" r="1" fill="white"/></svg></span>
                <span>Quản lý hộ nghèo</span>
            </a>
            <a class="nav-item" href="./DataCollection.html">
                <span class="nav-icon"><svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M2.5 5.5h11v1.5h-11V5.5Zm0 3h7v1.5h-7V8.5Zm0 3h5v1.5h-5V11.5Z" fill="white" opacity="0.9"/><path d="M10.5 3v10" stroke="white" stroke-width="1.2" opacity="0.7"/></svg></span>
                <span>Thu thập & cập nhật dữ liệu</span>
            </a>
            <a class="nav-item active" href="./PolicyList.html">
                <span class="nav-icon"><svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M3 13V3h10v10H3Z" stroke="white" stroke-width="1.3"/><path d="M5 6.5h6M5 9h3.5" stroke="white" stroke-width="1.2" stroke-linecap="round"/></svg></span>
                <span>Chính sách & báo cáo</span>
            </a>
            <a class="nav-item" href="./GISMap.html">
                <span class="nav-icon"><svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M2.7 7.3c0-2.5 2-4.5 4.5-4.5s4.5 2 4.5 4.5-2 4.5-4.5 4.5c-.7 0-1.3-.15-1.9-.44l-2.05.58.55-1.95c-.36-.62-.6-1.34-.6-2.09Z" stroke="white" stroke-width="1.3"/><path d="M6.5 6.8c0-.7.6-1.2 1.2-1.2.7 0 1.2.5 1.2 1.2 0 .6-.5 1.2-1.2 1.2-.7 0-1.2-.6-1.2-1.2Z" fill="white"/></svg></span>
                <span>Bản đồ nghèo (GIS)</span>
            </a>
            <a class="nav-item" href="./ActivityLogs.html">
                <span class="nav-icon"><svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M4.5 3.5h7m-7 9h7M8 1.5v2m0 9v2M5.5 6h5L9.8 10H6.2L5.5 6Z" stroke="white" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/></svg></span>
                <span>Nhật ký hoạt động</span>
            </a>
        </nav>
    </aside>

    <main>
        <div class="page-header">
            <div>
                <h1 id="page-title">Thêm bài viết mới</h1>
                <p id="page-desc">Nhập nội dung, đính kèm tài liệu và phân quyền hiển thị cho bài viết.</p>
            </div>
        </div>

        <div class="card">
            <div class="card-title">Thông tin bài viết</div>
            <div class="form-grid">
                <div class="form-group">
                    <label for="title">Tiêu đề bài viết</label>
                    <input id="title" type="text" placeholder="Nhập tiêu đề bài viết...">
                    <div class="error" id="error-title"></div>
                </div>
                <div class="form-group">
                    <label for="category">Loại bài viết</label>
                    <select id="category">
                        <option value="">Chọn loại bài viết</option>
                        <option value="policy">Chính sách</option>
                        <option value="report">Báo cáo</option>
                        <option value="guide">Hướng dẫn</option>
                        <option value="news">Tin tức giảm nghèo</option>
                        <option value="other">Khác</option>
                    </select>
                    <div class="error" id="error-category"></div>
                </div>
            </div>
            <div class="form-group">
                <label for="summary">Mô tả ngắn</label>
                <textarea id="summary" maxlength="300" placeholder="Viết mô tả tóm tắt nội dung (tối đa 300 ký tự)..."></textarea>
                <div class="helper"><span id="summary-count">0</span>/300 ký tự</div>
            </div>
            <div class="form-group">
                <label>Thẻ (Tags)</label>
                <div class="tag-input" id="tag-input">
                    <input id="tag-field" type="text" placeholder="Nhập thẻ và nhấn Enter">
                </div>
                <div class="helper">Tùy chọn. Nhập để tạo thẻ, nhấn dấu x để xoá.</div>
            </div>
        </div>

        <div class="card editor-card">
            <div class="card-title">Nội dung bài viết</div>
            <div class="toolbar" id="toolbar">
                <button class="tool-btn" data-cmd="bold" type="button">B</button>
                <button class="tool-btn" data-cmd="italic" type="button"><em>I</em></button>
                <button class="tool-btn" data-cmd="underline" type="button"><u>U</u></button>
                <button class="tool-btn" data-cmd="formatBlock" data-value="h1" type="button">H1</button>
                <button class="tool-btn" data-cmd="formatBlock" data-value="h2" type="button">H2</button>
                <button class="tool-btn" data-cmd="formatBlock" data-value="h3" type="button">H3</button>
                <button class="tool-btn" data-cmd="insertUnorderedList" type="button">• List</button>
                <button class="tool-btn" data-cmd="insertOrderedList" type="button">1. List</button>
                <button class="tool-btn" data-cmd="formatBlock" data-value="blockquote" type="button">Quote</button>
                <button class="tool-btn" id="link-btn" type="button">Link</button>
            </div>
            <div id="editor" class="editor empty" contenteditable="true" data-placeholder="Nhập nội dung bài viết..."></div>
            <div class="error" id="error-content"></div>
        </div>

        <div class="card">
            <div class="card-title">Tệp đính kèm (PDF)</div>
            <label class="dropzone" id="dropzone">
                <input id="file-input" type="file" accept="application/pdf" multiple>
                <div>
                    <h4>Kéo thả file PDF vào đây hoặc bấm để chọn tệp</h4>
                    <p>Chỉ nhận .pdf, dung lượng tối đa 20MB mỗi file.</p>
                </div>
            </label>
            <div class="file-list" id="file-list"></div>
        </div>

        <div class="card">
            <div class="card-title">Thông tin hiển thị &amp; phân quyền</div>
            <div class="toggle-row">
                <label class="checkbox">
                    <input type="checkbox" id="is-public">
                    <span>Hiển thị công khai cho người dân</span>
                </label>
                <div class="form-group">
                    <label for="access-level">Mức độ truy cập</label>
                    <select id="access-level">
                        <option value="public">Công khai</option>
                        <option value="internal">Nội bộ</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="publisher">Cơ quan ban hành</label>
                    <select id="publisher">
                        <option value="molisa">Bộ LĐTBXH</option>
                        <option value="province">Tỉnh</option>
                        <option value="district">Huyện</option>
                        <option value="commune">Xã</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="footer-actions">
            <button class="btn-primary" id="submit-btn" type="button">Đăng bài</button>
            <button class="btn-secondary" id="draft-btn" type="button">Lưu nháp</button>
            <button class="btn-ghost" id="cancel-btn" type="button">Hủy</button>
        </div>
    </main>
</div>

<div class="toast" id="toast">Đã lưu bài viết thành công</div>

<script>
    const mode = new URLSearchParams(window.location.search).get('mode') === 'edit' ? 'edit' : 'create';
    const pageTitle = document.getElementById('page-title');
    const submitBtn = document.getElementById('submit-btn');
    const draftBtn = document.getElementById('draft-btn');
    const cancelBtn = document.getElementById('cancel-btn');
    const titleInput = document.getElementById('title');
    const categoryInput = document.getElementById('category');
    const summaryInput = document.getElementById('summary');
    const summaryCount = document.getElementById('summary-count');
    const editor = document.getElementById('editor');
    const dropzone = document.getElementById('dropzone');
    const fileInput = document.getElementById('file-input');
    const fileList = document.getElementById('file-list');
    const toast = document.getElementById('toast');
    const errorTitle = document.getElementById('error-title');
    const errorCategory = document.getElementById('error-category');
    const errorContent = document.getElementById('error-content');
    const tagField = document.getElementById('tag-field');
    const tagInput = document.getElementById('tag-input');

    const attachments = [];
    const tags = [];

    const sampleData = {
        title: 'Hướng dẫn cập nhật chuẩn nghèo đa chiều giai đoạn 2026-2030',
        category: 'policy',
        summary: 'Quy định khung tiêu chí, mức chuẩn nghèo đa chiều áp dụng từ năm 2026, hướng dẫn rà soát và cập nhật dữ liệu hộ nghèo.',
        content: '<h3>1. Mục tiêu</h3><p>Bảo đảm thống nhất cách xác định chuẩn nghèo đa chiều, làm cơ sở cho phân bổ nguồn lực.</p><ul><li>Điều chỉnh ngưỡng thu nhập.</li><li>Bổ sung tiêu chí dịch vụ xã hội cơ bản.</li><li>Hướng dẫn rà soát hằng năm.</li></ul>',
        tags: ['chuẩn nghèo', 'hướng dẫn'],
        files: [
            { name: 'Huong_dan_chuan_ngheo_2026_2030.pdf', size: 1024 * 320 },
            { name: 'Phu_luc_mau_bieu.pdf', size: 1024 * 180 }
        ],
        isPublic: true,
        accessLevel: 'internal',
        publisher: 'molisa'
    };

    function bytesToSize(bytes) {
        const mb = bytes / (1024 * 1024);
        return `${mb.toFixed(1)} MB`;
    }

    function addFile(file) {
        attachments.push({ name: file.name, size: file.size });
        renderFiles();
    }

    function renderFiles() {
        fileList.innerHTML = '';
        attachments.forEach((file, index) => {
            const item = document.createElement('div');
            item.className = 'file-item';

            const meta = document.createElement('div');
            meta.className = 'file-meta';
            const icon = document.createElement('div');
            icon.className = 'icon-pdf';
            icon.textContent = 'PDF';
            const name = document.createElement('div');
            name.innerHTML = `${file.name} <br><small>${bytesToSize(file.size)}</small>`;
            meta.append(icon, name);

            const removeBtn = document.createElement('button');
            removeBtn.className = 'icon-trash';
            removeBtn.textContent = 'Xóa';
            removeBtn.addEventListener('click', () => {
                attachments.splice(index, 1);
                renderFiles();
            });

            item.append(meta, removeBtn);
            fileList.appendChild(item);
        });
    }

    function handleFiles(files) {
        const maxSize = 20 * 1024 * 1024;
        Array.from(files).forEach(file => {
            if (file.type !== 'application/pdf') return;
            if (file.size > maxSize) return;
            addFile(file);
        });
    }

    dropzone.addEventListener('click', () => fileInput.click());
    dropzone.addEventListener('dragover', event => { event.preventDefault(); dropzone.style.borderColor = 'var(--blue-500)'; });
    dropzone.addEventListener('dragleave', () => { dropzone.style.borderColor = 'var(--gray-300)'; });
    dropzone.addEventListener('drop', event => {
        event.preventDefault();
        dropzone.style.borderColor = 'var(--gray-300)';
        handleFiles(event.dataTransfer.files);
    });
    fileInput.addEventListener('change', event => handleFiles(event.target.files));

    summaryInput.addEventListener('input', () => {
        summaryCount.textContent = summaryInput.value.length;
    });

    function renderTags() {
        const chips = Array.from(tagInput.querySelectorAll('.tag-chip'));
        chips.forEach(chip => chip.remove());
        tags.forEach((tag, index) => {
            const chip = document.createElement('span');
            chip.className = 'tag-chip';
            chip.textContent = tag;
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.textContent = '×';
            btn.addEventListener('click', () => {
                tags.splice(index, 1);
                renderTags();
            });
            chip.appendChild(btn);
            tagInput.insertBefore(chip, tagField);
        });
    }

    tagField.addEventListener('keydown', event => {
        if (event.key === 'Enter' && tagField.value.trim()) {
            event.preventDefault();
            tags.push(tagField.value.trim());
            tagField.value = '';
            renderTags();
        }
    });

    function applyToolbar(command, value) {
        document.execCommand(command, false, value || null);
        editor.focus();
        togglePlaceholder();
    }

    document.getElementById('toolbar').addEventListener('click', event => {
        if (!(event.target instanceof HTMLElement)) return;
        const btn = event.target.closest('[data-cmd]');
        if (!btn) return;
        const cmd = btn.dataset.cmd;
        const value = btn.dataset.value || null;
        applyToolbar(cmd, value);
    });

    document.getElementById('link-btn').addEventListener('click', () => {
        const url = prompt('Nhập liên kết');
        if (!url) return;
        applyToolbar('createLink', url);
    });

    function togglePlaceholder() {
        const text = editor.textContent.trim();
        if (text.length === 0 && editor.innerHTML.trim() === '') {
            editor.classList.add('empty');
        } else {
            editor.classList.remove('empty');
        }
    }

    editor.addEventListener('input', togglePlaceholder);
    editor.addEventListener('focus', togglePlaceholder);

    function setError(el, message) {
        el.textContent = message;
    }

    function clearErrors() {
        [titleInput, categoryInput, editor].forEach(el => el.classList.remove('invalid'));
        [errorTitle, errorCategory, errorContent].forEach(el => el.textContent = '');
    }

    function validate() {
        clearErrors();
        let valid = true;
        if (!titleInput.value.trim()) {
            titleInput.classList.add('invalid');
            setError(errorTitle, 'Tiêu đề không được để trống');
            valid = false;
        }
        if (!categoryInput.value) {
            categoryInput.classList.add('invalid');
            setError(errorCategory, 'Vui lòng chọn loại bài viết');
            valid = false;
        }
        const contentText = editor.textContent.trim();
        if (!contentText) {
            editor.classList.add('invalid');
            setError(errorContent, 'Nội dung không được để trống');
            valid = false;
        }
        return valid;
    }

    function showToast(message) {
        toast.textContent = message;
        toast.style.display = 'block';
        setTimeout(() => { toast.style.display = 'none'; }, 2000);
    }

    function preloadData() {
        if (mode !== 'edit') return;
        pageTitle.textContent = 'Chỉnh sửa bài viết';
        submitBtn.textContent = 'Cập nhật bài viết';
        titleInput.value = sampleData.title;
        categoryInput.value = sampleData.category;
        summaryInput.value = sampleData.summary;
        summaryCount.textContent = sampleData.summary.length;
        editor.innerHTML = sampleData.content;
        togglePlaceholder();
        tags.push(...sampleData.tags);
        renderTags();
        sampleData.files.forEach(file => attachments.push(file));
        renderFiles();
        document.getElementById('is-public').checked = sampleData.isPublic;
        document.getElementById('access-level').value = sampleData.accessLevel;
        document.getElementById('publisher').value = sampleData.publisher;
    }

    submitBtn.addEventListener('click', () => {
        if (!validate()) return;
        showToast(mode === 'edit' ? 'Đã cập nhật bài viết thành công' : 'Đã lưu bài viết thành công');
    });

    draftBtn.addEventListener('click', () => {
        showToast('Đã lưu nháp');
    });

    cancelBtn.addEventListener('click', () => {
        window.location.href = './PolicyList.html';
    });

    preloadData();
    togglePlaceholder();
</script>
</body>
</html>
